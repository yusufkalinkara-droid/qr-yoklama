<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Yoklama Sistemi - Güvenli (Düzeltilmiş)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <!-- SheetJS for Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        #qrcode canvas {
            margin: 0 auto;
            border-radius: 12px;
        }
        @keyframes countdown {
            0% { width: 100%; }
            100% { width: 0%; }
        }
        .countdown-bar {
            animation: countdown var(--duration) linear;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-900 via-blue-800 to-indigo-900 min-h-screen">
    
    <!-- Mod Seçim Ekranı -->
    <div id="selectScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md">
            <div class="bg-white rounded-3xl shadow-2xl p-8">
                <h1 class="text-3xl font-bold text-center mb-2 text-gray-800">
                    QR Yoklama Sistemi
                </h1>
                <p class="text-center text-gray-600 mb-8">Düzeltilmiş Versiyon 🔧</p>
                
                <div class="space-y-4">
                    <button onclick="showTeacherPasswordModal()" class="w-full bg-gradient-to-r from-purple-500 to-indigo-600 text-white py-6 rounded-2xl font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all">
                        📝 Öğretmen Modu
                    </button>
                    
                    <button onclick="showStudentMode()" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white py-6 rounded-2xl font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all">
                        ✅ Öğrenci Modu
                    </button>
                </div>

                <div class="mt-8 p-4 bg-blue-50 rounded-xl">
                    <p class="text-sm text-gray-700">
                        <strong>🔐 Güvenlik Özellikleri:</strong><br/>
                        • Dinamik QR kod (30 sn yenilenir)<br/>
                        • Zaman sınırlı geçerlilik<br/>
                        • Tekrarlı yoklama engelleme<br/>
                        • GPS konum kontrolü<br/>
                        • Cihaz parmak izi kontrolü
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Şifre Modal -->
    <div id="passwordModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">🔐 Öğretmen Girişi</h2>
                <button onclick="closePasswordModal()" class="text-gray-500 hover:text-gray-700 text-2xl">
                    ×
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">
                        Şifre
                    </label>
                    <input
                        type="password"
                        id="teacherPassword"
                        placeholder="Öğretmen şifrenizi girin"
                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-purple-500 focus:outline-none"
                    />
                    <p id="passwordError" class="text-red-500 text-sm mt-2 hidden">
                        ❌ Şifre yanlış! Lütfen tekrar deneyin.
                    </p>
                </div>
                
                <button onclick="verifyPassword()" class="w-full bg-gradient-to-r from-purple-500 to-indigo-600 text-white py-3 rounded-xl font-bold hover:shadow-lg transition-all">
                    Giriş Yap
                </button>
            </div>
        </div>
    </div>

    <!-- Öğretmen Modu Ekranı -->
    <div id="teacherScreen" class="hidden min-h-screen p-4">
        <div class="max-w-4xl mx-auto">
            <div class="bg-white rounded-3xl shadow-2xl p-6">
                <div class="flex items-center justify-between mb-6">
                    <h1 class="text-2xl font-bold text-gray-800">
                        📝 Öğretmen Paneli
                    </h1>
                    <button onclick="showSelectScreen()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                        ← Geri
                    </button>
                </div>

                <div id="teacherLoading" class="text-center py-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto mb-4"></div>
                    <p class="text-gray-600">QR kod oluşturuluyor...</p>
                </div>

                <div id="teacherContent" class="hidden">
                    <!-- Ders Bilgisi -->
                    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 p-4 rounded-2xl mb-4">
                        <label class="block text-gray-700 font-semibold mb-2">
                            Ders Adı
                        </label>
                        <input
                            type="text"
                            id="courseName"
                            placeholder="Örn: Matematik 101"
                            class="w-full px-4 py-2 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none"
                        />
                    </div>

                    <!-- Güvenlik Ayarları -->
                    <div class="bg-gradient-to-br from-orange-50 to-red-50 p-4 rounded-2xl mb-4">
                        <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                            <span>🔐</span> Güvenlik Ayarları
                        </h3>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">QR Yenileme (saniye)</label>
                                <select id="qrRefreshTime" class="w-full px-3 py-2 border rounded-lg text-sm" onchange="restartQRRefresh()">
                                    <option value="30">30 saniye</option>
                                    <option value="60">60 saniye</option>
                                    <option value="120">120 saniye</option>
                                    <option value="0">Otomatik kapalı</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">QR Geçerlilik (dk)</label>
                                <select id="qrValidityTime" class="w-full px-3 py-2 border rounded-lg text-sm">
                                    <option value="2">2 dakika</option>
                                    <option value="5" selected>5 dakika</option>
                                    <option value="10">10 dakika</option>
                                    <option value="15">15 dakika</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-3">
                            <label class="flex items-center gap-2 text-sm">
                                <input type="checkbox" id="preventDuplicate" checked class="rounded">
                                <span class="text-gray-700">Aynı kişiden tekrar yoklama alma</span>
                            </label>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-purple-50 to-indigo-50 p-6 rounded-2xl mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl font-bold text-gray-800">
                                Yoklama QR Kodu
                            </h2>
                            <div class="flex items-center gap-2" id="qrStatus">
                                <span class="animate-pulse text-green-600 text-sm">🔴 Canlı</span>
                            </div>
                        </div>
                        
                        <!-- QR Kod Countdown -->
                        <div class="mb-2 bg-gray-200 rounded-full h-2 overflow-hidden">
                            <div id="qrCountdown" class="countdown-bar h-full bg-gradient-to-r from-green-500 to-blue-500"></div>
                        </div>
                        <p class="text-center text-xs text-gray-600 mb-4" id="qrTimeRemaining">
                            Otomatik yenileme: --
                        </p>
                        
                        <div id="qrcode" class="bg-white p-6 rounded-xl shadow-lg"></div>
                        <p class="text-center mt-4 text-sm text-gray-600">
                            Öğrenciler bu kodu okutarak yoklama verebilir
                        </p>
                        <p class="text-center text-xs text-orange-600 mt-2" id="qrExpireTime">
                            ⏱️ QR kod geçerlilik süresi: --
                        </p>
                        <button onclick="manualRefreshQR()" class="w-full mt-4 bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700">
                            🔄 Hemen Yenile
                        </button>
                    </div>

                    <div class="bg-blue-50 p-4 rounded-xl mb-6">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="text-2xl">📍</span>
                                <span class="font-semibold text-gray-800">Sınıf Konumu:</span>
                            </div>
                            <button onclick="updateLocation()" class="bg-blue-600 text-white px-3 py-1 rounded-lg hover:bg-blue-700 text-sm flex items-center gap-1">
                                🔄 Konumu Güncelle
                            </button>
                        </div>
                        <p class="text-sm text-gray-700" id="teacherLocation">
                            Konum alınıyor...
                        </p>
                        <p class="text-xs text-gray-500 mt-1" id="locationTime"></p>
                        <div class="mt-2">
                            <span id="connectionStatus" class="text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded">
                                🔌 Bağlantı durumu kontrol ediliyor...
                            </span>
                        </div>
                    </div>

                    <div class="bg-green-50 p-4 rounded-xl">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-2">
                                <span class="text-2xl">👥</span>
                                <span class="font-bold text-gray-800">Yoklama Listesi</span>
                            </div>
                            <div class="flex items-center gap-2">
                                <button onclick="loadAttendanceList()" class="bg-blue-500 text-white px-3 py-1 rounded-lg hover:bg-blue-600 text-sm">
                                    🔄
                                </button>
                                <span id="attendanceCount" class="bg-green-600 text-white px-3 py-1 rounded-full text-sm font-bold">
                                    0
                                </span>
                            </div>
                        </div>
                        
                        <div id="attendanceList" class="space-y-2 max-h-96 overflow-y-auto">
                            <p class="text-center text-gray-500 py-4">
                                Henüz yoklama yok
                            </p>
                        </div>

                        <div class="grid grid-cols-2 gap-3 mt-4">
                            <button onclick="downloadExcel()" class="bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2">
                                <span>📊</span> Excel İndir
                            </button>
                            <button onclick="downloadCSV()" class="bg-teal-600 text-white py-2 rounded-lg hover:bg-teal-700 flex items-center justify-center gap-2">
                                <span>📄</span> CSV İndir
                            </button>
                        </div>

                        <button onclick="clearAttendance()" class="w-full mt-3 bg-red-500 text-white py-2 rounded-lg hover:bg-red-600">
                            🗑️ Listeyi Temizle
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Öğrenci Modu Ekranı -->
    <div id="studentScreen" class="hidden min-h-screen p-4">
        <div class="max-w-md mx-auto">
            <div class="bg-white rounded-3xl shadow-2xl p-6">
                <div class="flex items-center justify-between mb-6">
                    <h1 class="text-2xl font-bold text-gray-800">
                        ✅ Öğrenci Paneli
                    </h1>
                    <button onclick="showSelectScreen()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                        ← Geri
                    </button>
                </div>

                <div class="space-y-4 mb-6">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">
                            Adınız Soyadınız
                        </label>
                        <input
                            type="text"
                            id="studentName"
                            placeholder="Örn: Ahmet Yılmaz"
                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-green-500 focus:outline-none"
                        />
                    </div>

                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">
                            Öğrenci Numarası (Opsiyonel)
                        </label>
                        <input
                            type="text"
                            id="studentNumber"
                            placeholder="Örn: 20240001"
                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-green-500 focus:outline-none"
                        />
                    </div>

                    <button onclick="startQRScanner()" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white py-4 rounded-xl font-bold text-lg hover:shadow-xl transform hover:scale-105 transition-all">
                        📷 QR Kod Okut
                    </button>
                </div>

                <!-- Kamera Görüntüsü -->
                <div id="scannerContainer" class="hidden mb-6">
                    <div class="relative bg-black rounded-xl overflow-hidden">
                        <video id="video" class="w-full" autoplay playsinline></video>
                        <canvas id="canvas" class="hidden"></canvas>
                        <div class="absolute inset-0 border-4 border-green-400 pointer-events-none"></div>
                        <div class="absolute top-4 left-4 right-4 bg-green-500/80 text-white px-4 py-2 rounded-lg text-center font-bold">
                            QR kodu kamera ile tarayın
                        </div>
                    </div>
                    <button onclick="stopQRScanner()" class="w-full mt-4 bg-red-500 text-white py-2 rounded-lg hover:bg-red-600">
                        ❌ İptal
                    </button>
                </div>

                <!-- Sonuç Mesajı -->
                <div id="scanResult" class="hidden"></div>

                <div class="mt-6 p-4 bg-blue-50 rounded-xl">
                    <p class="text-sm text-gray-700">
                        <strong>ℹ️ Bilgi:</strong><br/>
                        • Adınızı girip QR kodu okutun<br/>
                        • Sınıfın 50m içinde olmalısınız<br/>
                        • Yoklamanız otomatik kaydedilir<br/>
                        • Her öğrenci sadece 1 kez yoklama verebilir
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // GÜVENLİK AYARLARI
        // ============================================
        const TEACHER_PASSWORD = "ogretmen123";
        let qrRefreshInterval = null;
        let qrCountdownInterval = null;
        let currentLocation = null;
        let currentSessionId = localStorage.getItem('currentSessionId') || null;

        // Cihaz parmak izi oluştur
        function getDeviceFingerprint() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.textBaseline = 'top';
            ctx.font = '14px Arial';
            ctx.fillText('Browser fingerprint', 2, 2);
            
            return canvas.toDataURL() + 
                   navigator.userAgent + 
                   navigator.language + 
                   screen.width + 'x' + screen.height +
                   new Date().getTimezoneOffset();
        }

        // Basit hash fonksiyonu
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash).toString(36);
        }

        const deviceId = simpleHash(getDeviceFingerprint());

        // Şifre modalını aç
        function showTeacherPasswordModal() {
            document.getElementById('passwordModal').classList.remove('hidden');
            document.getElementById('teacherPassword').value = '';
            document.getElementById('passwordError').classList.add('hidden');
            setTimeout(() => {
                document.getElementById('teacherPassword').focus();
            }, 100);
        }

        // Şifre modalını kapat
        function closePasswordModal() {
            document.getElementById('passwordModal').classList.add('hidden');
        }

        // Şifre doğrulama
        function verifyPassword() {
            const password = document.getElementById('teacherPassword').value;
            const errorMsg = document.getElementById('passwordError');
            
            if (password === TEACHER_PASSWORD) {
                closePasswordModal();
                showTeacherMode();
            } else {
                errorMsg.classList.remove('hidden');
                document.getElementById('teacherPassword').value = '';
                document.getElementById('teacherPassword').focus();
                
                setTimeout(() => {
                    errorMsg.classList.add('hidden');
                }, 3000);
            }
        }

        // Enter tuşu ile şifre girişi
        document.addEventListener('DOMContentLoaded', function() {
            const passwordInput = document.getElementById('teacherPassword');
            if (passwordInput) {
                passwordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        verifyPassword();
                    }
                });
            }
        });

        // Modal dışına tıklanınca kapat
        document.getElementById('passwordModal')?.addEventListener('click', function(e) {
            if (e.target.id === 'passwordModal') {
                closePasswordModal();
            }
        });

        // ============================================
        // FIREBASE YAPLANDIRMASI
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyDHILOLgcQ6WU--hjO8qd__7ApN_-4Jm3w",
            authDomain: "qr-yoklama-sistemi-f54f5.firebaseapp.com",
            databaseURL: "https://qr-yoklama-sistemi-f54f5-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "qr-yoklama-sistemi-f54f5",
            storageBucket: "qr-yoklama-sistemi-f54f5.firebasestorage.app",
            messagingSenderId: "431067742021",
            appId: "1:431067742021:web:784c0ad599aab659fa882c"
        };

        let database;
        let useFirebase = false;

        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            useFirebase = true;
            updateConnectionStatus('✅ Bulut bağlantısı aktif');
        } catch (error) {
            console.log('Firebase bağlantısı kurulamadı, localStorage kullanılacak');
            useFirebase = false;
            updateConnectionStatus('⚠️ Yerel depolama kullanılıyor');
        }

        function updateConnectionStatus(message) {
            const statusEl = document.getElementById('connectionStatus');
            if (statusEl) {
                statusEl.textContent = message;
                if (message.includes('✅')) {
                    statusEl.className = 'text-xs bg-green-200 text-green-800 px-2 py-1 rounded';
                } else if (message.includes('⚠️')) {
                    statusEl.className = 'text-xs bg-yellow-200 text-yellow-800 px-2 py-1 rounded';
                } else {
                    statusEl.className = 'text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded';
                }
            }
        }

        let currentQRData = null;
        let videoStream = null;
        let scanInterval = null;

        // Ekran geçişleri
        function showSelectScreen() {
            document.getElementById('selectScreen').classList.remove('hidden');
            document.getElementById('teacherScreen').classList.add('hidden');
            document.getElementById('studentScreen').classList.add('hidden');
            stopQRScanner();
            stopQRRefresh();
        }

        function showTeacherMode() {
            document.getElementById('selectScreen').classList.add('hidden');
            document.getElementById('teacherScreen').classList.remove('hidden');
            document.getElementById('teacherLoading').classList.remove('hidden');
            document.getElementById('teacherContent').classList.add('hidden');
            
            setTimeout(() => {
                initTeacherMode();
            }, 500);
        }

        function showStudentMode() {
            document.getElementById('selectScreen').classList.add('hidden');
            document.getElementById('studentScreen').classList.remove('hidden');
        }

        // Öğretmen modu başlatma
        function initTeacherMode() {
            getLocationAndInitialize();
        }

        // Konum al ve başlat
        function getLocationAndInitialize() {
            if (!navigator.geolocation) {
                showLocationError('Tarayıcınız konum özelliğini desteklemiyor!');
                return;
            }

            document.getElementById('teacherLocation').innerHTML = '<span class="text-blue-600">📍 Konum alınıyor...</span>';

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    currentLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy
                    };
                    
                    updateLocationDisplay(currentLocation);
                    generateQRCode(currentLocation);
                    loadAttendanceList();
                    startQRRefresh();
                    
                    document.getElementById('teacherLoading').classList.add('hidden');
                    document.getElementById('teacherContent').classList.remove('hidden');

                    if (useFirebase && currentSessionId) {
                        listenToFirebaseUpdates();
                    }
                },
                (error) => {
                    let errorMessage = 'Konum alınamadı! ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage += 'Konum izni verilmedi. Lütfen tarayıcı ayarlarından konum iznini açın.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage += 'Konum bilgisi kullanılamıyor.';
                            break;
                        case error.TIMEOUT:
                            errorMessage += 'Konum alma zaman aşımına uğradı.';
                            break;
                        default:
                            errorMessage += 'Bilinmeyen bir hata oluştu.';
                    }
                    showLocationError(errorMessage);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        // QR otomatik yenileme başlat
        function startQRRefresh() {
            stopQRRefresh();
            
            const refreshTime = parseInt(document.getElementById('qrRefreshTime').value);
            if (refreshTime === 0) {
                document.getElementById('qrTimeRemaining').textContent = 'Otomatik yenileme: Kapalı';
                return;
            }

            let remainingTime = refreshTime;
            const countdownBar = document.getElementById('qrCountdown');
            countdownBar.style.setProperty('--duration', refreshTime + 's');
            countdownBar.style.width = '100%';
            
            setTimeout(() => {
                countdownBar.classList.add('countdown-bar');
            }, 10);

            qrCountdownInterval = setInterval(() => {
                remainingTime--;
                document.getElementById('qrTimeRemaining').textContent = 
                    `Otomatik yenileme: ${remainingTime} saniye`;
                
                if (remainingTime <= 0) {
                    manualRefreshQR();
                }
            }, 1000);

            qrRefreshInterval = setInterval(() => {
                if (currentLocation) {
                    generateQRCode(currentLocation);
                    remainingTime = refreshTime;
                    
                    countdownBar.classList.remove('countdown-bar');
                    countdownBar.style.width = '100%';
                    setTimeout(() => {
                        countdownBar.classList.add('countdown-bar');
                    }, 10);
                }
            }, refreshTime * 1000);
        }

        function stopQRRefresh() {
            if (qrRefreshInterval) {
                clearInterval(qrRefreshInterval);
                qrRefreshInterval = null;
            }
            if (qrCountdownInterval) {
                clearInterval(qrCountdownInterval);
                qrCountdownInterval = null;
            }
        }

        function restartQRRefresh() {
            startQRRefresh();
        }

        function manualRefreshQR() {
            if (currentLocation) {
                generateQRCode(currentLocation);
                stopQRRefresh();
                startQRRefresh();
                showNotification('✅ QR kod yenilendi!', 'success');
            }
        }

        function updateLocation() {
            document.getElementById('teacherLocation').innerHTML = '<span class="text-blue-600 animate-pulse">🔄 Konum güncelleniyor...</span>';
            
            if (!navigator.geolocation) {
                showLocationError('Tarayıcınız konum özelliğini desteklemiyor!');
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    currentLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy
                    };
                    
                    updateLocationDisplay(currentLocation);
                    generateQRCode(currentLocation);
                    
                    showNotification('✅ Konum güncellendi! Yeni QR kod oluşturuldu.', 'success');
                },
                (error) => {
                    let errorMessage = 'Konum güncellenemedi! ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage += 'Konum izni verilmedi.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage += 'Konum bilgisi kullanılamıyor.';
                            break;
                        case error.TIMEOUT:
                            errorMessage += 'Zaman aşımı.';
                            break;
                        default:
                            errorMessage += 'Bilinmeyen hata.';
                    }
                    showLocationError(errorMessage);
                    showNotification('❌ ' + errorMessage, 'error');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        function updateLocationDisplay(location) {
            const now = new Date().toLocaleString('tr-TR');
            document.getElementById('teacherLocation').innerHTML = `
                <span class="text-green-700 font-semibold">✅ Aktif</span><br/>
                <span class="text-gray-700">Enlem: ${location.lat.toFixed(6)}</span><br/>
                <span class="text-gray-700">Boylam: ${location.lng.toFixed(6)}</span><br/>
                <span class="text-xs text-gray-500">Doğruluk: ±${location.accuracy.toFixed(0)}m</span>
            `;
            document.getElementById('locationTime').textContent = `Son güncelleme: ${now}`;
        }

        function showLocationError(message) {
            document.getElementById('teacherLocation').innerHTML = `
                <span class="text-red-600 font-semibold">❌ Hata!</span><br/>
                <span class="text-red-700 text-xs">${message}</span><br/>
                <button onclick="updateLocation()" class="mt-2 bg-red-600 text-white px-3 py-1 rounded text-xs hover:bg-red-700">
                    Tekrar Dene
                </button>
            `;
            document.getElementById('teacherLoading').classList.add('hidden');
            document.getElementById('teacherContent').classList.remove('hidden');
        }

        function listenToFirebaseUpdates() {
            if (!useFirebase || !currentSessionId) return;

            const sessionRef = database.ref('sessions/' + currentSessionId + '/attendances');
            sessionRef.on('value', (snapshot) => {
                loadAttendanceList();
            });
        }

        // ÖNEMLİ: Session ID'yi SABİT TUT
        function generateQRCode(location) {
            const timestamp = Date.now();
            
            // İLK DEFA oluşturuluyorsa yeni sessionId
            if (!currentSessionId) {
                currentSessionId = 'session_' + timestamp;
                localStorage.setItem('currentSessionId', currentSessionId);
                console.log('✅ Yeni session oluşturuldu:', currentSessionId);
            }
            
            const validityMinutes = parseInt(document.getElementById('qrValidityTime').value);
            const expiryTime = timestamp + (validityMinutes * 60 * 1000);
            
            const qrData = {
                type: 'attendance',
                sessionId: currentSessionId,  // SABİT KALIYOR!
                location: location,
                radius: 50,
                timestamp: timestamp,
                expiryTime: expiryTime,
                randomToken: Math.random().toString(36).substring(7)
            };
            
            currentQRData = qrData;
            
            const qrcodeDiv = document.getElementById('qrcode');
            qrcodeDiv.innerHTML = '';
            
            new QRCode(qrcodeDiv, {
                text: JSON.stringify(qrData),
                width: 256,
                height: 256,
                colorDark: '#000000',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.H
            });

            const expiryDate = new Date(expiryTime);
            document.getElementById('qrExpireTime').textContent = 
                `⏱️ QR kod şu saate kadar geçerli: ${expiryDate.toLocaleTimeString('tr-TR')}`;

            if (useFirebase) {
                database.ref('sessions/' + currentSessionId).update({
                    lastUpdated: firebase.database.ServerValue.TIMESTAMP,
                    expiryTime: expiryTime,
                    location: location,
                    courseName: document.getElementById('courseName')?.value || 'Belirtilmemiş'
                }).catch(() => {
                    database.ref('sessions/' + currentSessionId).set({
                        createdAt: firebase.database.ServerValue.TIMESTAMP,
                        expiryTime: expiryTime,
                        location: location,
                        courseName: document.getElementById('courseName')?.value || 'Belirtilmemiş'
                    });
                });
            }
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                    Math.cos(φ1) * Math.cos(φ2) *
                    Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c;
        }

        async function startQRScanner() {
            const studentName = document.getElementById('studentName').value.trim();
            
            if (!studentName) {
                alert('Lütfen adınızı soyadınızı girin!');
                return;
            }
            
            document.getElementById('scannerContainer').classList.remove('hidden');
            document.getElementById('scanResult').classList.add('hidden');
            
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                
                const video = document.getElementById('video');
                video.srcObject = videoStream;
                video.play();
                
                scanInterval = setInterval(scanQRCode, 300);
            } catch (err) {
                alert('Kamera erişimi reddedildi!');
                stopQRScanner();
            }
        }

        function scanQRCode() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                
                if (code) {
                    processQRCode(code.data);
                }
            }
        }

        function processQRCode(qrData) {
            stopQRScanner();
            
            try {
                const qrContent = JSON.parse(qrData);
                
                const now = Date.now();
                if (now > qrContent.expiryTime) {
                    showResult('expired', null);
                    return;
                }
                
                const studentName = document.getElementById('studentName').value.trim();
                const studentNumber = document.getElementById('studentNumber').value.trim();
                
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const studentLoc = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude,
                                accuracy: position.coords.accuracy
                            };
                            
                            const distance = calculateDistance(
                                studentLoc.lat,
                                studentLoc.lng,
                                qrContent.location.lat,
                                qrContent.location.lng
                            );
                            
                            if (distance > qrContent.radius) {
                                showResult('out_of_range', distance.toFixed(0));
                                return;
                            }
                            
                            checkDuplicateAttendance(studentName, studentNumber, qrContent.sessionId, (isDuplicate) => {
                                if (isDuplicate) {
                                    showResult('duplicate', distance.toFixed(0));
                                    return;
                                }
                                
                                const attendance = {
                                    name: studentName,
                                    studentNumber: studentNumber || 'Belirtilmemiş',
                                    time: new Date().toLocaleString('tr-TR'),
                                    timestamp: Date.now(),
                                    distance: distance.toFixed(0),
                                    sessionId: qrContent.sessionId,
                                    location: studentLoc,
                                    deviceId: deviceId,
                                    accuracy: studentLoc.accuracy
                                };
                                
                                saveAttendance(attendance);
                                showResult('success', distance.toFixed(0));
                            });
                        },
                        (error) => {
                            alert('Konum erişimi reddedildi!');
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 0
                        }
                    );
                }
            } catch (err) {
                alert('Geçersiz QR kod!');
            }
        }

        function checkDuplicateAttendance(name, number, sessionId, callback) {
            const preventDuplicate = document.getElementById('preventDuplicate')?.checked !== false;
            
            if (!preventDuplicate) {
                callback(false);
                return;
            }
            
            if (useFirebase) {
                database.ref('sessions/' + sessionId + '/attendances').once('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        const list = Object.values(data);
                        const isDuplicate = list.some(att => 
                            att.name === name || 
                            (number && att.studentNumber === number) ||
                            att.deviceId === deviceId
                        );
                        callback(isDuplicate);
                    } else {
                        callback(false);
                    }
                });
            } else {
                const list = JSON.parse(localStorage.getItem('attendanceList') || '[]');
                const isDuplicate = list.some(att => 
                    (att.sessionId === sessionId && att.name === name) ||
                    (number && att.sessionId === sessionId && att.studentNumber === number) ||
                    (att.sessionId === sessionId && att.deviceId === deviceId)
                );
                callback(isDuplicate);
            }
        }

        function showResult(status, distance) {
            const resultDiv = document.getElementById('scanResult');
            resultDiv.classList.remove('hidden');
            
            if (status === 'success') {
                resultDiv.innerHTML = `
                    <div class="p-4 rounded-xl mb-4 bg-green-50 border-2 border-green-500">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">✅</span>
                            <div>
                                <p class="font-bold text-green-800">Yoklama Başarılı!</p>
                                <p class="text-sm text-green-700">Mesafe: ${distance} metre</p>
                                <p class="text-xs text-green-600 mt-1">Kaydınız buluta yüklendi</p>
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('studentName').value = '';
                document.getElementById('studentNumber').value = '';
            } else if (status === 'expired') {
                resultDiv.innerHTML = `
                    <div class="p-4 rounded-xl mb-4 bg-orange-50 border-2 border-orange-500">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">⏱️</span>
                            <div>
                                <p class="font-bold text-orange-800">QR Kod Süresi Dolmuş!</p>
                                <p class="text-sm text-orange-700">Öğretmeninizden yeni QR kod isteyin.</p>
                            </div>
                        </div>
                    </div>
                `;
            } else if (status === 'duplicate') {
                resultDiv.innerHTML = `
                    <div class="p-4 rounded-xl mb-4 bg-yellow-50 border-2 border-yellow-500">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">⚠️</span>
                            <div>
                                <p class="font-bold text-yellow-800">Zaten Yoklama Verdiniz!</p>
                                <p class="text-sm text-yellow-700">Bu oturumda daha önce yoklama kaydınız var.</p>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="p-4 rounded-xl mb-4 bg-red-50 border-2 border-red-500">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">❌</span>
                            <div>
                                <p class="font-bold text-red-800">Yoklama Başarısız!</p>
                                <p class="text-sm text-red-700">Sınıf dışındasınız!<br/>Mesafe: ${distance} metre (Max: 50m)</p>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function stopQRScanner() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            if (scanInterval) {
                clearInterval(scanInterval);
                scanInterval = null;
            }
            document.getElementById('scannerContainer').classList.add('hidden');
        }

        function saveAttendance(attendance) {
            if (useFirebase) {
                const attendanceRef = database.ref('sessions/' + attendance.sessionId + '/attendances');
                attendanceRef.push(attendance);
            } else {
                let list = JSON.parse(localStorage.getItem('attendanceList') || '[]');
                list.push(attendance);
                localStorage.setItem('attendanceList', JSON.stringify(list));
            }
            loadAttendanceList();
        }

        // ÖNEMLİ: Session bazında filtrele
        function loadAttendanceList() {
            if (useFirebase && currentSessionId) {
                database.ref('sessions/' + currentSessionId + '/attendances').once('value', (snapshot) => {
                    const data = snapshot.val();
                    let list = [];
                    if (data) {
                        list = Object.values(data);
                    }
                    displayAttendanceList(list);
                });
            } else {
                const allList = JSON.parse(localStorage.getItem('attendanceList') || '[]');
                // Sadece mevcut session'ı göster
                const list = currentSessionId ? allList.filter(att => att.sessionId === currentSessionId) : allList;
                console.log('Toplam yoklama:', allList.length, 'Bu session:', list.length);
                displayAttendanceList(list);
            }
        }

        function displayAttendanceList(list) {
            const container = document.getElementById('attendanceList');
            const count = document.getElementById('attendanceCount');
            
            if (!container || !count) return;
            
            count.textContent = list.length;
            
            if (list.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-4">Henüz yoklama yok</p>';
            } else {
                list.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                
                container.innerHTML = list.map((student, idx) => `
                    <div class="bg-white p-3 rounded-lg shadow flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <span class="text-xl">✅</span>
                            <div>
                                <p class="font-semibold text-gray-800">${student.name}</p>
                                <p class="text-xs text-gray-600">${student.studentNumber}</p>
                                <p class="text-xs text-gray-500">${student.time}</p>
                            </div>
                        </div>
                        <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">
                            ${student.distance}m
                        </span>
                    </div>
                `).join('');
            }
        }

        function showNotification(message, type) {
            const existingNotif = document.getElementById('notification');
            if (existingNotif) {
                existingNotif.remove();
            }

            const notification = document.createElement('div');
            notification.id = 'notification';
            notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            } text-white font-semibold`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function downloadExcel() {
            getAttendanceData((list) => {
                if (list.length === 0) {
                    alert('İndirilecek veri yok!');
                    return;
                }

                const courseName = document.getElementById('courseName')?.value || 'Yoklama';
                const date = new Date().toLocaleDateString('tr-TR').replace(/\./g, '-');
                
                const excelData = list.map((student, idx) => ({
                    'Sıra': idx + 1,
                    'Ad Soyad': student.name,
                    'Öğrenci No': student.studentNumber || '-',
                    'Tarih/Saat': student.time,
                    'Mesafe (m)': student.distance,
                    'Enlem': student.location?.lat?.toFixed(6) || '-',
                    'Boylam': student.location?.lng?.toFixed(6) || '-',
                    'Doğruluk': student.accuracy ? `±${student.accuracy}m` : '-'
                }));

                const ws = XLSX.utils.json_to_sheet(excelData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Yoklama');

                ws['!cols'] = [
                    { wch: 6 }, { wch: 25 }, { wch: 15 }, { wch: 20 },
                    { wch: 12 }, { wch: 12 }, { wch: 12 }, { wch: 12 }
                ];

                XLSX.writeFile(wb, `${courseName}_Yoklama_${date}.xlsx`);
            });
        }

        function downloadCSV() {
            getAttendanceData((list) => {
                if (list.length === 0) {
                    alert('İndirilecek veri yok!');
                    return;
                }

                const courseName = document.getElementById('courseName')?.value || 'Yoklama';
                const date = new Date().toLocaleDateString('tr-TR').replace(/\./g, '-');

                let csv = 'Sıra,Ad Soyad,Öğrenci No,Tarih/Saat,Mesafe (m),Enlem,Boylam,Doğruluk\n';

                list.forEach((student, idx) => {
                    csv += `${idx + 1},"${student.name}","${student.studentNumber || '-'}","${student.time}",${student.distance},${student.location?.lat?.toFixed(6) || '-'},${student.location?.lng?.toFixed(6) || '-'},${student.accuracy ? '±' + student.accuracy + 'm' : '-'}\n`;
                });

                const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `${courseName}_Yoklama_${date}.csv`;
                link.click();
            });
        }

        function getAttendanceData(callback) {
            if (useFirebase && currentSessionId) {
                database.ref('sessions/' + currentSessionId + '/attendances').once('value', (snapshot) => {
                    const data = snapshot.val();
                    let list = [];
                    if (data) {
                        list = Object.values(data);
                    }
                    callback(list);
                });
            } else {
                const allList = JSON.parse(localStorage.getItem('attendanceList') || '[]');
                // Sadece mevcut session'ı al
                const list = currentSessionId ? allList.filter(att => att.sessionId === currentSessionId) : allList;
                callback(list);
            }
        }

        function clearAttendance() {
            if (confirm('Yoklama listesini temizlemek istediğinizden emin misiniz?')) {
                if (useFirebase && currentSessionId) {
                    database.ref('sessions/' + currentSessionId + '/attendances').remove();
                } else {
                    // Sadece mevcut session'ı temizle
                    const allList = JSON.parse(localStorage.getItem('attendanceList') || '[]');
                    const otherSessions = allList.filter(att => att.sessionId !== currentSessionId);
                    localStorage.setItem('attendanceList', JSON.stringify(otherSessions));
                }
                loadAttendanceList();
            }
        }
    </script>
</body>
</html>
