<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Yoklama Sistemi - GÃ¼venli</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <!-- SheetJS for Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <style>
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        #qrcode canvas {
            margin: 0 auto;
            border-radius: 12px;
        }
        @keyframes countdown {
            0% { width: 100%; }
            100% { width: 0%; }
        }
        .countdown-bar {
            animation: countdown var(--duration) linear;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-900 via-blue-800 to-indigo-900 min-h-screen">
    
    <!-- Mod SeÃ§im EkranÄ± -->
    <div id="selectScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md">
            <div class="bg-white rounded-3xl shadow-2xl p-8">
                <h1 class="text-3xl font-bold text-center mb-2 text-gray-800">
                    QR Yoklama Sistemi
                </h1>
                <p class="text-center text-gray-600 mb-8">GÃ¼venli Versiyon ğŸ”</p>
                
                <div class="space-y-4">
                    <button onclick="showTeacherPasswordModal()" class="w-full bg-gradient-to-r from-purple-500 to-indigo-600 text-white py-6 rounded-2xl font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all">
                        ğŸ“ Ã–ÄŸretmen Modu
                    </button>
                    
                    <button onclick="showStudentMode()" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white py-6 rounded-2xl font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all">
                        âœ… Ã–ÄŸrenci Modu
                    </button>
                </div>

                <div class="mt-8 p-4 bg-blue-50 rounded-xl">
                    <p class="text-sm text-gray-700">
                        <strong>ğŸ” GÃ¼venlik Ã–zellikleri:</strong><br/>
                        â€¢ Dinamik QR kod (30 sn yenilenir)<br/>
                        â€¢ Zaman sÄ±nÄ±rlÄ± geÃ§erlilik<br/>
                        â€¢ TekrarlÄ± yoklama engelleme<br/>
                        â€¢ GPS konum kontrolÃ¼<br/>
                        â€¢ Cihaz parmak izi kontrolÃ¼
                    </p>
                </div>

                <div class="mt-4 p-3 bg-yellow-50 rounded-xl">
                    <p class="text-xs text-gray-600">
                        <strong>ğŸ’¡ Ä°pucu:</strong> QR kod paylaÅŸÄ±lsa bile sadece sÄ±nÄ±fta olanlar yoklama verebilir
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Åifre Modal -->
    <div id="passwordModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">ğŸ” Ã–ÄŸretmen GiriÅŸi</h2>
                <button onclick="closePasswordModal()" class="text-gray-500 hover:text-gray-700 text-2xl">
                    Ã—
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">
                        Åifre
                    </label>
                    <input
                        type="password"
                        id="teacherPassword"
                        placeholder="Ã–ÄŸretmen ÅŸifrenizi girin"
                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-purple-500 focus:outline-none"
                    />
                    <p id="passwordError" class="text-red-500 text-sm mt-2 hidden">
                        âŒ Åifre yanlÄ±ÅŸ! LÃ¼tfen tekrar deneyin.
                    </p>
                </div>
                
                <button onclick="verifyPassword()" class="w-full bg-gradient-to-r from-purple-500 to-indigo-600 text-white py-3 rounded-xl font-bold hover:shadow-lg transition-all">
                    GiriÅŸ Yap
                </button>
            </div>
        </div>
    </div>

    <!-- Ã–ÄŸretmen Modu EkranÄ± -->
    <div id="teacherScreen" class="hidden min-h-screen p-4">
        <div class="max-w-4xl mx-auto">
            <div class="bg-white rounded-3xl shadow-2xl p-6">
                <div class="flex items-center justify-between mb-6">
                    <h1 class="text-2xl font-bold text-gray-800">
                        ğŸ“ Ã–ÄŸretmen Paneli
                    </h1>
                    <button onclick="showSelectScreen()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                        â† Geri
                    </button>
                </div>

                <div id="teacherLoading" class="text-center py-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto mb-4"></div>
                    <p class="text-gray-600">QR kod oluÅŸturuluyor...</p>
                </div>

                <div id="teacherContent" class="hidden">
                    <!-- Ders Bilgisi -->
                    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 p-4 rounded-2xl mb-4">
                        <label class="block text-gray-700 font-semibold mb-2">
                            Ders AdÄ±
                        </label>
                        <input
                            type="text"
                            id="courseName"
                            placeholder="Ã–rn: Matematik 101"
                            class="w-full px-4 py-2 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none"
                        />
                    </div>

                    <!-- GÃ¼venlik AyarlarÄ± -->
                    <div class="bg-gradient-to-br from-orange-50 to-red-50 p-4 rounded-2xl mb-4">
                        <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                            <span>ğŸ”</span> GÃ¼venlik AyarlarÄ±
                        </h3>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">QR Yenileme (saniye)</label>
                                <select id="qrRefreshTime" class="w-full px-3 py-2 border rounded-lg text-sm" onchange="restartQRRefresh()">
                                    <option value="30">30 saniye</option>
                                    <option value="60">60 saniye</option>
                                    <option value="120">120 saniye</option>
                                    <option value="0">Otomatik kapalÄ±</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">QR GeÃ§erlilik (dk)</label>
                                <select id="qrValidityTime" class="w-full px-3 py-2 border rounded-lg text-sm">
                                    <option value="2">2 dakika</option>
                                    <option value="5" selected>5 dakika</option>
                                    <option value="10">10 dakika</option>
                                    <option value="15">15 dakika</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-3">
                            <label class="flex items-center gap-2 text-sm">
                                <input type="checkbox" id="preventDuplicate" checked class="rounded">
                                <span class="text-gray-700">AynÄ± kiÅŸiden tekrar yoklama alma</span>
                            </label>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-purple-50 to-indigo-50 p-6 rounded-2xl mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl font-bold text-gray-800">
                                Yoklama QR Kodu
                            </h2>
                            <div class="flex items-center gap-2" id="qrStatus">
                                <span class="animate-pulse text-green-600 text-sm">ğŸ”´ CanlÄ±</span>
                            </div>
                        </div>
                        
                        <!-- QR Kod Countdown -->
                        <div class="mb-2 bg-gray-200 rounded-full h-2 overflow-hidden">
                            <div id="qrCountdown" class="countdown-bar h-full bg-gradient-to-r from-green-500 to-blue-500"></div>
                        </div>
                        <p class="text-center text-xs text-gray-600 mb-4" id="qrTimeRemaining">
                            Otomatik yenileme: --
                        </p>
                        
                        <div id="qrcode" class="bg-white p-6 rounded-xl shadow-lg"></div>
                        <p class="text-center mt-4 text-sm text-gray-600">
                            Ã–ÄŸrenciler bu kodu okutarak yoklama verebilir
                        </p>
                        <p class="text-center text-xs text-orange-600 mt-2" id="qrExpireTime">
                            â±ï¸ QR kod geÃ§erlilik sÃ¼resi: --
                        </p>
                        <button onclick="manualRefreshQR()" class="w-full mt-4 bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700">
                            ğŸ”„ Hemen Yenile
                        </button>
                    </div>

                    <div class="bg-blue-50 p-4 rounded-xl mb-6">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="text-2xl">ğŸ“</span>
                                <span class="font-semibold text-gray-800">SÄ±nÄ±f Konumu:</span>
                            </div>
                            <button onclick="updateLocation()" class="bg-blue-600 text-white px-3 py-1 rounded-lg hover:bg-blue-700 text-sm flex items-center gap-1">
                                ğŸ”„ Konumu GÃ¼ncelle
                            </button>
                        </div>
                        <p class="text-sm text-gray-700" id="teacherLocation">
                            Konum alÄ±nÄ±yor...
                        </p>
                        <p class="text-xs text-gray-500 mt-1" id="locationTime"></p>
                        <div class="mt-2">
                            <span id="connectionStatus" class="text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded">
                                ğŸ”Œ BaÄŸlantÄ± durumu kontrol ediliyor...
                            </span>
                        </div>
                    </div>

                    <div class="bg-green-50 p-4 rounded-xl">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-2">
                                <span class="text-2xl">ğŸ‘¥</span>
                                <span class="font-bold text-gray-800">Yoklama Listesi</span>
                            </div>
                            <span id="attendanceCount" class="bg-green-600 text-white px-3 py-1 rounded-full text-sm font-bold">
                                0
                            </span>
                        </div>
                        
                        <div id="attendanceList" class="space-y-2 max-h-96 overflow-y-auto">
                            <p class="text-center text-gray-500 py-4">
                                HenÃ¼z yoklama yok
                            </p>
                        </div>

                        <div class="grid grid-cols-2 gap-3 mt-4">
                            <button onclick="downloadExcel()" class="bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2">
                                <span>ğŸ“Š</span> Excel Ä°ndir
                            </button>
                            <button onclick="downloadCSV()" class="bg-teal-600 text-white py-2 rounded-lg hover:bg-teal-700 flex items-center justify-center gap-2">
                                <span>ğŸ“„</span> CSV Ä°ndir
                            </button>
                        </div>

                        <button onclick="clearAttendance()" class="w-full mt-3 bg-red-500 text-white py-2 rounded-lg hover:bg-red-600">
                            ğŸ—‘ï¸ Listeyi Temizle
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Ã–ÄŸrenci Modu EkranÄ± -->
    <div id="studentScreen" class="hidden min-h-screen p-4">
        <div class="max-w-md mx-auto">
            <div class="bg-white rounded-3xl shadow-2xl p-6">
                <div class="flex items-center justify-between mb-6">
                    <h1 class="text-2xl font-bold text-gray-800">
                        âœ… Ã–ÄŸrenci Paneli
                    </h1>
                    <button onclick="showSelectScreen()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                        â† Geri
                    </button>
                </div>

                <div class="space-y-4 mb-6">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">
                            AdÄ±nÄ±z SoyadÄ±nÄ±z
                        </label>
                        <input
                            type="text"
                            id="studentName"
                            placeholder="Ã–rn: Ahmet YÄ±lmaz"
                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-green-500 focus:outline-none"
                        />
                    </div>

                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">
                            Ã–ÄŸrenci NumarasÄ± (Opsiyonel)
                        </label>
                        <input
                            type="text"
                            id="studentNumber"
                            placeholder="Ã–rn: 20240001"
                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-green-500 focus:outline-none"
                        />
                    </div>

                    <button onclick="startQRScanner()" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white py-4 rounded-xl font-bold text-lg hover:shadow-xl transform hover:scale-105 transition-all">
                        ğŸ“· QR Kod Okut
                    </button>
                </div>

                <!-- Kamera GÃ¶rÃ¼ntÃ¼sÃ¼ -->
                <div id="scannerContainer" class="hidden mb-6">
                    <div class="relative bg-black rounded-xl overflow-hidden">
                        <video id="video" class="w-full" autoplay playsinline></video>
                        <canvas id="canvas" class="hidden"></canvas>
                        <div class="absolute inset-0 border-4 border-green-400 pointer-events-none"></div>
                        <div class="absolute top-4 left-4 right-4 bg-green-500/80 text-white px-4 py-2 rounded-lg text-center font-bold">
                            QR kodu kamera ile tarayÄ±n
                        </div>
                    </div>
                    <button onclick="stopQRScanner()" class="w-full mt-4 bg-red-500 text-white py-2 rounded-lg hover:bg-red-600">
                        âŒ Ä°ptal
                    </button>
                </div>

                <!-- SonuÃ§ MesajÄ± -->
                <div id="scanResult" class="hidden"></div>

                <div class="mt-6 p-4 bg-blue-50 rounded-xl">
                    <p class="text-sm text-gray-700">
                        <strong>â„¹ï¸ Bilgi:</strong><br/>
                        â€¢ AdÄ±nÄ±zÄ± girip QR kodu okutun<br/>
                        â€¢ SÄ±nÄ±fÄ±n 50m iÃ§inde olmalÄ±sÄ±nÄ±z<br/>
                        â€¢ YoklamanÄ±z otomatik kaydedilir<br/>
                        â€¢ Her Ã¶ÄŸrenci sadece 1 kez yoklama verebilir
                    </p>
                </div>

                <div class="mt-4 p-3 bg-orange-50 rounded-xl">
                    <p class="text-xs text-gray-600">
                        <strong>âš ï¸ UyarÄ±:</strong> GPS sahteciliÄŸi tespit edilirse yoklamanÄ±z geÃ§ersiz sayÄ±lacaktÄ±r.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // GÃœVENLÄ°K AYARLARI
        // ============================================
        const TEACHER_PASSWORD = "ogretmen123";
        let qrRefreshInterval = null;
        let qrCountdownInterval = null;
        let currentLocation = null;

        // Cihaz parmak izi oluÅŸtur
        function getDeviceFingerprint() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.textBaseline = 'top';
            ctx.font = '14px Arial';
            ctx.fillText('Browser fingerprint', 2, 2);
            
            return canvas.toDataURL() + 
                   navigator.userAgent + 
                   navigator.language + 
                   screen.width + 'x' + screen.height +
                   new Date().getTimezoneOffset();
        }

        // Basit hash fonksiyonu
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash).toString(36);
        }

        const deviceId = simpleHash(getDeviceFingerprint());

        // Åifre modalÄ±nÄ± aÃ§
        function showTeacherPasswordModal() {
            document.getElementById('passwordModal').classList.remove('hidden');
            document.getElementById('teacherPassword').value = '';
            document.getElementById('passwordError').classList.add('hidden');
            setTimeout(() => {
                document.getElementById('teacherPassword').focus();
            }, 100);
        }

        // Åifre modalÄ±nÄ± kapat
        function closePasswordModal() {
            document.getElementById('passwordModal').classList.add('hidden');
        }

        // Åifre doÄŸrulama
        function verifyPassword() {
            const password = document.getElementById('teacherPassword').value;
            const errorMsg = document.getElementById('passwordError');
            
            if (password === TEACHER_PASSWORD) {
                closePasswordModal();
                showTeacherMode();
            } else {
                errorMsg.classList.remove('hidden');
                document.getElementById('teacherPassword').value = '';
                document.getElementById('teacherPassword').focus();
                
                setTimeout(() => {
                    errorMsg.classList.add('hidden');
                }, 3000);
            }
        }

        // Enter tuÅŸu ile ÅŸifre giriÅŸi
        document.addEventListener('DOMContentLoaded', function() {
            const passwordInput = document.getElementById('teacherPassword');
            if (passwordInput) {
                passwordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        verifyPassword();
                    }
                });
            }
        });

        // Modal dÄ±ÅŸÄ±na tÄ±klanÄ±nca kapat
        document.getElementById('passwordModal')?.addEventListener('click', function(e) {
            if (e.target.id === 'passwordModal') {
                closePasswordModal();
            }
        });

        // ============================================
        // FIREBASE YAPLANDIRMASI
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyDHILOLgcQ6WU--hjO8qd__7ApN_-4Jm3w",
            authDomain: "qr-yoklama-sistemi-f54f5.firebaseapp.com",
            databaseURL: "https://qr-yoklama-sistemi-f54f5-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "qr-yoklama-sistemi-f54f5",
            storageBucket: "qr-yoklama-sistemi-f54f5.firebasestorage.app",
            messagingSenderId: "431067742021",
            appId: "1:431067742021:web:784c0ad599aab659fa882c"
        };

        let database;
        let useFirebase = false;

        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            useFirebase = true;
            updateConnectionStatus('âœ… Bulut baÄŸlantÄ±sÄ± aktif');
        } catch (error) {
            console.log('Firebase baÄŸlantÄ±sÄ± kurulamadÄ±, localStorage kullanÄ±lacak');
            useFirebase = false;
            updateConnectionStatus('âš ï¸ Yerel depolama kullanÄ±lÄ±yor');
        }

        function updateConnectionStatus(message) {
            const statusEl = document.getElementById('connectionStatus');
            if (statusEl) {
                statusEl.textContent = message;
                if (message.includes('âœ…')) {
                    statusEl.className = 'text-xs bg-green-200 text-green-800 px-2 py-1 rounded';
                } else if (message.includes('âš ï¸')) {
                    statusEl.className = 'text-xs bg-yellow-200 text-yellow-800 px-2 py-1 rounded';
                } else {
                    statusEl.className = 'text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded';
                }
            }
        }

        let currentQRData = null;
        let videoStream = null;
        let scanInterval = null;
        let currentSessionId = null;

        // Ekran geÃ§iÅŸleri
        function showSelectScreen() {
            document.getElementById('selectScreen').classList.remove('hidden');
            document.getElementById('teacherScreen').classList.add('hidden');
            document.getElementById('studentScreen').classList.add('hidden');
            stopQRScanner();
            stopQRRefresh();
        }

        function showTeacherMode() {
            document.getElementById('selectScreen').classList.add('hidden');
            document.getElementById('teacherScreen').classList.remove('hidden');
            document.getElementById('teacherLoading').classList.remove('hidden');
            document.getElementById('teacherContent').classList.add('hidden');
            
            setTimeout(() => {
                initTeacherMode();
            }, 500);
        }

        function showStudentMode() {
            document.getElementById('selectScreen').classList.add('hidden');
            document.getElementById('studentScreen').classList.remove('hidden');
        }

        // Ã–ÄŸretmen modu baÅŸlatma
        function initTeacherMode() {
            getLocationAndInitialize();
        }

        // Konum al ve baÅŸlat
        function getLocationAndInitialize() {
            if (!navigator.geolocation) {
                showLocationError('TarayÄ±cÄ±nÄ±z konum Ã¶zelliÄŸini desteklemiyor!');
                return;
            }

            document.getElementById('teacherLocation').innerHTML = '<span class="text-blue-600">ğŸ“ Konum alÄ±nÄ±yor...</span>';

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    currentLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy
                    };
                    
                    updateLocationDisplay(currentLocation);
                    generateQRCode(currentLocation);
                    loadAttendanceList();
                    startQRRefresh();
                    
                    document.getElementById('teacherLoading').classList.add('hidden');
                    document.getElementById('teacherContent').classList.remove('hidden');

                    if (useFirebase && currentSessionId) {
                        listenToFirebaseUpdates();
                    }
                },
                (error) => {
                    let errorMessage = 'Konum alÄ±namadÄ±! ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage += 'Konum izni verilmedi. LÃ¼tfen tarayÄ±cÄ± ayarlarÄ±ndan konum iznini aÃ§Ä±n.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage += 'Konum bilgisi kullanÄ±lamÄ±yor.';
                            break;
                        case error.TIMEOUT:
                            errorMessage += 'Konum alma zaman aÅŸÄ±mÄ±na uÄŸradÄ±.';
                            break;
                        default:
                            errorMessage += 'Bilinmeyen bir hata oluÅŸtu.';
                    }
                    showLocationError(errorMessage);
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        // QR otomatik yenileme baÅŸlat
        function startQRRefresh() {
            stopQRRefresh();
            
            const refreshTime = parseInt(document.getElementById('qrRefreshTime').value);
            if (refreshTime === 0) {
                document.getElementById('qrTimeRemaining').textContent = 'Otomatik yenileme: KapalÄ±';
                return;
            }

            let remainingTime = refreshTime;
            const countdownBar = document.getElementById('qrCountdown');
            countdownBar.style.setProperty('--duration', refreshTime + 's');
            countdownBar.style.width = '100%';
            
            // Countdown animasyonu
            setTimeout(() => {
                countdownBar.classList.add('countdown-bar');
            }, 10);

            qrCountdownInterval = setInterval(() => {
                remainingTime--;
                document.getElementById('qrTimeRemaining').textContent = 
                    `Otomatik yenileme: ${remainingTime} saniye`;
                
                if (remainingTime <= 0) {
                    manualRefreshQR();
                }
            }, 1000);

            qrRefreshInterval = setInterval(() => {
                if (currentLocation) {
                    generateQRCode(currentLocation);
                    remainingTime = refreshTime;
                    
                    // Countdown resetle
                    countdownBar.classList.remove('countdown-bar');
                    countdownBar.style.width = '100%';
                    setTimeout(() => {
                        countdownBar.classList.add('countdown-bar');
                    }, 10);
                }
            }, refreshTime * 1000);
        }

        // QR yenilemeyi durdur
        function stopQRRefresh() {
            if (qrRefreshInterval) {
                clearInterval(qrRefreshInterval);
                qrRefreshInterval = null;
            }
            if (qrCountdownInterval) {
                clearInterval(qrCountdownInterval);
                qrCountdownInterval = null;
            }
        }

        // QR yenilemeyi yeniden baÅŸlat
        function restartQRRefresh() {
            startQRRefresh();
        }

        // Manuel QR yenileme
        function manualRefreshQR() {
            if (currentLocation) {
                generateQRCode(currentLocation);
                stopQRRefresh();
                startQRRefresh();
                showNotification('âœ… QR kod yenilendi!', 'success');
            }
        }

        // Konum gÃ¼ncelle
        function updateLocation() {
            document.getElementById('teacherLocation').innerHTML = '<span class="text-blue-600 animate-pulse">ğŸ”„ Konum gÃ¼ncelleniyor...</span>';
            
            if (!navigator.geolocation) {
                showLocationError('TarayÄ±cÄ±nÄ±z konum Ã¶zelliÄŸini desteklemiyor!');
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    currentLocation = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy
                    };
                    
                    updateLocationDisplay(currentLocation);
                    generateQRCode(currentLocation);
                    
                    showNotification('âœ… Konum gÃ¼ncellendi! Yeni QR kod oluÅŸturuldu.', 'success');
                },
                (error) => {
                    let errorMessage = 'Konum gÃ¼ncellenemedi! ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage += 'Konum izni verilmedi.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage += 'Konum bilgisi kullanÄ±lamÄ±yor.';
                            break;
                        case error.TIMEOUT:
                            errorMessage += 'Zaman aÅŸÄ±mÄ±.';
                            break;
                        default:
                            errorMessage += 'Bilinmeyen hata.';
                    }
                    showLocationError(errorMessage);
                    showNotification('âŒ ' + errorMessage, 'error');
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        // Konum gÃ¶rÃ¼ntÃ¼sÃ¼nÃ¼ gÃ¼ncelle
        function updateLocationDisplay(location) {
            const now = new Date().toLocaleString('tr-TR');
            document.getElementById('teacherLocation').innerHTML = `
                <span class="text-green-700 font-semibold">âœ… Aktif</span><br/>
                <span class="text-gray-700">Enlem: ${location.lat.toFixed(6)}</span><br/>
                <span class="text-gray-700">Boylam: ${location.lng.toFixed(6)}</span><br/>
                <span class="text-xs text-gray-500">DoÄŸruluk: Â±${location.accuracy.toFixed(0)}m</span>
            `;
            document.getElementById('locationTime').textContent = `Son gÃ¼ncelleme: ${now}`;
        }

        // Konum hatasÄ± gÃ¶ster
        function showLocationError(message) {
            document.getElementById('teacherLocation').innerHTML = `
                <span class="text-red-600 font-semibold">âŒ Hata!</span><br/>
                <span class="text-red-700 text-xs">${message}</span><br/>
                <button onclick="updateLocation()" class="mt-2 bg-red-600 text-white px-3 py-1 rounded text-xs hover:bg-red-700">
                    Tekrar Dene
                </button>
            `;
            document.getElementById('teacherLoading').classList.add('hidden');
            document.getElementById('teacherContent').classList.remove('hidden');
        }

        // Firebase gerÃ§ek zamanlÄ± dinleme
        function listenToFirebaseUpdates() {
            if (!useFirebase || !currentSessionId) return;

            const sessionRef = database.ref('sessions/' + currentSessionId + '/attendances');
            sessionRef.on('value', (snapshot) => {
                loadAttendanceList();
            });
        }

        // QR kod oluÅŸturma (zaman damgalÄ± ve geÃ§erlilik sÃ¼reli)
        function generateQRCode(location) {
            const timestamp = Date.now();
            currentSessionId = 'session_' + timestamp;
            
            const validityMinutes = parseInt(document.getElementById('qrValidityTime').value);
            const expiryTime = timestamp + (validityMinutes * 60 * 1000);
            
            const qrData = {
                type: 'attendance',
                sessionId: currentSessionId,
                location: location,
                radius: 50,
                timestamp: timestamp,
                expiryTime: expiryTime,
                randomToken: Math.random().toString(36).substring(7)
            };
            
            currentQRData = qrData;
            
            const qrcodeDiv = document.getElementById('qrcode');
            qrcodeDiv.innerHTML = '';
            
            new QRCode(qrcodeDiv, {
                text: JSON.stringify(qrData),
                width: 256,
                height: 256,
                colorDark: '#000000',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.H
            });

            // GeÃ§erlilik sÃ¼resini gÃ¶ster
            const expiryDate = new Date(expiryTime);
            document.getElementById('qrExpireTime').textContent = 
                `â±ï¸ QR kod ÅŸu saate kadar geÃ§erli: ${expiryDate.toLocaleTimeString('tr-TR')}`;

            // Firebase'e session kaydet
            if (useFirebase) {
                database.ref('sessions/' + currentSessionId).set({
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    expiryTime: expiryTime,
                    location: location,
                    courseName: document.getElementById('courseName')?.value || 'BelirtilmemiÅŸ'
                });
            }
        }

        // Mesafe hesaplama (Haversine formÃ¼lÃ¼)
        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const Ï†1 = lat1 * Math.PI / 180;
            const Ï†2 = lat2 * Math.PI / 180;
            const Î”Ï† = (lat2 - lat1) * Math.PI / 180;
            const Î”Î» = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Î”Ï† / 2) * Math.sin(Î”Ï† / 2) +
                    Math.cos(Ï†1) * Math.cos(Ï†2) *
                    Math.sin(Î”Î» / 2) * Math.sin(Î”Î» / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c;
        }

        // QR tarayÄ±cÄ± baÅŸlatma
        async function startQRScanner() {
            const studentName = document.getElementById('studentName').value.trim();
            
            if (!studentName) {
                alert('LÃ¼tfen adÄ±nÄ±zÄ± soyadÄ±nÄ±zÄ± girin!');
                return;
            }
            
            document.getElementById('scannerContainer').classList.remove('hidden');
            document.getElementById('scanResult').classList.add('hidden');
            
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                
                const video = document.getElementById('video');
                video.srcObject = videoStream;
                video.play();
                
                scanInterval = setInterval(scanQRCode, 300);
            } catch (err) {
                alert('Kamera eriÅŸimi reddedildi!');
                stopQRScanner();
            }
        }

        // QR kod tarama
        function scanQRCode() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                
                if (code) {
                    processQRCode(code.data);
                }
            }
        }

        // QR kod iÅŸleme (gÃ¼venlik kontrolleri ile)
        function processQRCode(qrData) {
            stopQRScanner();
            
            try {
                const qrContent = JSON.parse(qrData);
                
                // 1. QR kodun geÃ§erlilik sÃ¼resini kontrol et
                const now = Date.now();
                if (now > qrContent.expiryTime) {
                    showResult('expired', null);
                    return;
                }
                
                const studentName = document.getElementById('studentName').value.trim();
                const studentNumber = document.getElementById('studentNumber').value.trim();
                
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const studentLoc = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude,
                                accuracy: position.coords.accuracy
                            };
                            
                            const distance = calculateDistance(
                                studentLoc.lat,
                                studentLoc.lng,
                                qrContent.location.lat,
                                qrContent.location.lng
                            );
                            
                            // 2. Konum kontrolÃ¼
                            if (distance > qrContent.radius) {
                                showResult('out_of_range', distance.toFixed(0));
                                return;
                            }
                            
                            // 3. TekrarlÄ± yoklama kontrolÃ¼
                            checkDuplicateAttendance(studentName, studentNumber, qrContent.sessionId, (isDuplicate) => {
                                if (isDuplicate) {
                                    showResult('duplicate', distance.toFixed(0));
                                    return;
                                }
                                
                                // Yoklama kaydÄ± oluÅŸtur
                                const attendance = {
                                    name: studentName,
                                    studentNumber: studentNumber || 'BelirtilmemiÅŸ',
                                    time: new Date().toLocaleString('tr-TR'),
                                    timestamp: Date.now(),
                                    distance: distance.toFixed(0),
                                    sessionId: qrContent.sessionId,
                                    location: studentLoc,
                                    deviceId: deviceId,
                                    accuracy: studentLoc.accuracy
                                };
                                
                                saveAttendance(attendance);
                                showResult('success', distance.toFixed(0));
                            });
                        },
                        (error) => {
                            alert('Konum eriÅŸimi reddedildi!');
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 0
                        }
                    );
                }
            } catch (err) {
                alert('GeÃ§ersiz QR kod!');
            }
        }

        // TekrarlÄ± yoklama kontrolÃ¼
        function checkDuplicateAttendance(name, number, sessionId, callback) {
            const preventDuplicate = document.getElementById('preventDuplicate')?.checked !== false;
            
            if (!preventDuplicate) {
                callback(false);
                return;
            }
            
            if (useFirebase) {
                database.ref('sessions/' + sessionId + '/attendances').once('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        const list = Object.values(data);
                        const isDuplicate = list.some(att => 
                            att.name === name || 
                            (number && att.studentNumber === number) ||
                            att.deviceId === deviceId
                        );
                        callback(isDuplicate);
                    } else {
                        callback(false);
                    }
                });
            } else {
                const list = JSON.parse(localStorage.getItem('attendanceList') || '[]');
                const isDuplicate = list.some(att => 
                    (att.sessionId === sessionId && att.name === name) ||
                    (number && att.sessionId === sessionId && att.studentNumber === number) ||
                    (att.sessionId === sessionId && att.deviceId === deviceId)
                );
                callback(isDuplicate);
            }
        }

        // SonuÃ§ gÃ¶sterme
        function showResult(status, distance) {
            const resultDiv = document.getElementById('scanResult');
            resultDiv.classList.remove('hidden');
            
            if (status === 'success') {
                resultDiv.innerHTML = `
                    <div class="p-4 rounded-xl mb-4 bg-green-50 border-2 border-green-500">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">âœ…</span>
                            <div>
                                <p class="font-bold text-green-800">Yoklama BaÅŸarÄ±lÄ±!</p>
                                <p class="text-sm text-green-700">Mesafe: ${distance} metre</p>
                                <p class="text-xs text-green-600 mt-1">KaydÄ±nÄ±z buluta yÃ¼klendi</p>
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('studentName').value = '';
                document.getElementById('studentNumber').value = '';
            } else if (status === 'expired') {
                resultDiv.innerHTML = `
                    <div class="p-4 rounded-xl mb-4 bg-orange-50 border-2 border-orange-500">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">â±ï¸</span>
                            <div>
                                <p class="font-bold text-orange-800">QR Kod SÃ¼resi DolmuÅŸ!</p>
                                <p class="text-sm text-orange-700">Ã–ÄŸretmeninizden yeni QR kod isteyin.</p>
                            </div>
                        </div>
                    </div>
                `;
            } else if (status === 'duplicate') {
                resultDiv.innerHTML = `
                    <div class="p-4 rounded-xl mb-4 bg-yellow-50 border-2 border-yellow-500">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">âš ï¸</span>
                            <div>
                                <p class="font-bold text-yellow-800">Zaten Yoklama Verdiniz!</p>
                                <p class="text-sm text-yellow-700">Bu oturumda daha Ã¶nce yoklama kaydÄ±nÄ±z var.</p>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="p-4 rounded-xl mb-4 bg-red-50 border-2 border-red-500">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">âŒ</span>
                            <div>
                                <p class="font-bold text-red-800">Yoklama BaÅŸarÄ±sÄ±z!</p>
                                <p class="text-sm text-red-700">SÄ±nÄ±f dÄ±ÅŸÄ±ndasÄ±nÄ±z!<br/>Mesafe: ${distance} metre (Max: 50m)</p>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        // QR tarayÄ±cÄ± durdurma
        function stopQRScanner() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            if (scanInterval) {
                clearInterval(scanInterval);
                scanInterval = null;
            }
            document.getElementById('scannerContainer').classList.add('hidden');
        }

        // Yoklama kaydetme
        function saveAttendance(attendance) {
            if (useFirebase) {
                const attendanceRef = database.ref('sessions/' + attendance.sessionId + '/attendances');
                attendanceRef.push(attendance);
            } else {
                let list = JSON.parse(localStorage.getItem('attendanceList') || '[]');
                list.push(attendance);
                localStorage.setItem('attendanceList', JSON.stringify(list));
            }
            loadAttendanceList();
        }

        // Yoklama listesi yÃ¼kleme
        function loadAttendanceList() {
            if (useFirebase && currentSessionId) {
                database.ref('sessions/' + currentSessionId + '/attendances').once('value', (snapshot) => {
                    const data = snapshot.val();
                    let list = [];
                    if (data) {
                        list = Object.values(data);
                    }
                    displayAttendanceList(list);
                });
            } else {
                const list = JSON.parse(localStorage.getItem('attendanceList') || '[]');
                displayAttendanceList(list);
            }
        }

        // Yoklama listesini gÃ¶ster
        function displayAttendanceList(list) {
            const container = document.getElementById('attendanceList');
            const count = document.getElementById('attendanceCount');
            
            if (!container || !count) return;
            
            count.textContent = list.length;
            
            if (list.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-4">HenÃ¼z yoklama yok</p>';
            } else {
                list.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                
                container.innerHTML = list.map((student, idx) => `
                    <div class="bg-white p-3 rounded-lg shadow flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <span class="text-xl">âœ…</span>
                            <div>
                                <p class="font-semibold text-gray-800">${student.name}</p>
                                <p class="text-xs text-gray-600">${student.studentNumber}</p>
                                <p class="text-xs text-gray-500">${student.time}</p>
                            </div>
                        </div>
                        <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">
                            ${student.distance}m
                        </span>
                    </div>
                `).join('');
            }
        }

        // Bildirim gÃ¶ster
        function showNotification(message, type) {
            const existingNotif = document.getElementById('notification');
            if (existingNotif) {
                existingNotif.remove();
            }

            const notification = document.createElement('div');
            notification.id = 'notification';
            notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            } text-white font-semibold`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        // Excel indirme
        function downloadExcel() {
            getAttendanceData((list) => {
                if (list.length === 0) {
                    alert('Ä°ndirilecek veri yok!');
                    return;
                }

                const courseName = document.getElementById('courseName')?.value || 'Yoklama';
                const date = new Date().toLocaleDateString('tr-TR').replace(/\./g, '-');
                
                const excelData = list.map((student, idx) => ({
                    'SÄ±ra': idx + 1,
                    'Ad Soyad': student.name,
                    'Ã–ÄŸrenci No': student.studentNumber || '-',
                    'Tarih/Saat': student.time,
                    'Mesafe (m)': student.distance,
                    'Enlem': student.location?.lat?.toFixed(6) || '-',
                    'Boylam': student.location?.lng?.toFixed(6) || '-',
                    'DoÄŸruluk': student.accuracy ? `Â±${student.accuracy}m` : '-'
                }));

                const ws = XLSX.utils.json_to_sheet(excelData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Yoklama');

                ws['!cols'] = [
                    { wch: 6 }, { wch: 25 }, { wch: 15 }, { wch: 20 },
                    { wch: 12 }, { wch: 12 }, { wch: 12 }, { wch: 12 }
                ];

                XLSX.writeFile(wb, `${courseName}_Yoklama_${date}.xlsx`);
            });
        }

        // CSV indirme
        function downloadCSV() {
            getAttendanceData((list) => {
                if (list.length === 0) {
                    alert('Ä°ndirilecek veri yok!');
                    return;
                }

                const courseName = document.getElementById('courseName')?.value || 'Yoklama';
                const date = new Date().toLocaleDateString('tr-TR').replace(/\./g, '-');

                let csv = 'SÄ±ra,Ad Soyad,Ã–ÄŸrenci No,Tarih/Saat,Mesafe (m),Enlem,Boylam,DoÄŸruluk\n';

                list.forEach((student, idx) => {
                    csv += `${idx + 1},"${student.name}","${student.studentNumber || '-'}","${student.time}",${student.distance},${student.location?.lat?.toFixed(6) || '-'},${student.location?.lng?.toFixed(6) || '-'},${student.accuracy ? 'Â±' + student.accuracy + 'm' : '-'}\n`;
                });

                const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `${courseName}_Yoklama_${date}.csv`;
                link.click();
            });
        }

        // Veri alma yardÄ±mcÄ± fonksiyonu
        function getAttendanceData(callback) {
            if (useFirebase && currentSessionId) {
                database.ref('sessions/' + currentSessionId + '/attendances').once('value', (snapshot) => {
                    const data = snapshot.val();
                    let list = [];
                    if (data) {
                        list = Object.values(data);
                    }
                    callback(list);
                });
            } else {
                const list = JSON.parse(localStorage.getItem('attendanceList') || '[]');
                callback(list);
            }
        }

        // Listeyi temizle
        function clearAttendance() {
            if (confirm('Yoklama listesini temizlemek istediÄŸinizden emin misiniz?')) {
                if (useFirebase && currentSessionId) {
                    database.ref('sessions/' + currentSessionId + '/attendances').remove();
                } else {
                    localStorage.removeItem('attendanceList');
                }
                loadAttendanceList();
            }
        }
    </script>
</body>
</html>
