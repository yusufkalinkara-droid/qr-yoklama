<!DOCTYPE html>
<html lang="tr">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>QR Yoklama Sistemi - Güvenli (Geliştirilmiş)</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <script src="https://cdnjs.cloudflare.com/ajax/libs/qrcodejs/1.0.0/qrcode.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/jsqr@1.4.0/dist/jsQR.min.js"></script>
    
    <!-- Firebase -->
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-app-compat.js"></script>
    <script src="https://www.gstatic.com/firebasejs/10.7.1/firebase-database-compat.js"></script>
    
    <!-- SheetJS for Excel -->
    <script src="https://cdnjs.cloudflare.com/ajax/libs/xlsx/0.18.5/xlsx.full.min.js"></script>
    
    <!-- Leaflet for Map -->
    <link rel="stylesheet" href="https://unpkg.com/leaflet@1.9.4/dist/leaflet.css" />
    <script src="https://unpkg.com/leaflet@1.9.4/dist/leaflet.js"></script>
    
    <style>
        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.5; }
        }
        .animate-pulse {
            animation: pulse 2s cubic-bezier(0.4, 0, 0.6, 1) infinite;
        }
        #qrcode canvas {
            margin: 0 auto;
            border-radius: 12px;
        }
        @keyframes countdown {
            0% { width: 100%; }
            100% { width: 0%; }
        }
        .countdown-bar {
            animation: countdown var(--duration) linear;
        }
        #map {
            height: 400px;
            width: 100%;
            border-radius: 12px;
            z-index: 1;
        }
    </style>
</head>
<body class="bg-gradient-to-br from-blue-900 via-blue-800 to-indigo-900 min-h-screen">
    
    <!-- Mod Seçim Ekranı -->
    <div id="selectScreen" class="min-h-screen flex items-center justify-center p-4">
        <div class="w-full max-w-md">
            <div class="bg-white rounded-3xl shadow-2xl p-8">
                <h1 class="text-3xl font-bold text-center mb-2 text-gray-800">
                    QR Yoklama Sistemi
                </h1>
                <p class="text-center text-gray-600 mb-8">Güvenli Versiyon 🔐</p>
                
                <div class="space-y-4">
                    <button onclick="showTeacherPasswordModal()" class="w-full bg-gradient-to-r from-purple-500 to-indigo-600 text-white py-6 rounded-2xl font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all">
                        📝 Öğretmen Modu
                    </button>
                    
                    <button onclick="showStudentMode()" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white py-6 rounded-2xl font-bold text-lg shadow-lg hover:shadow-xl transform hover:scale-105 transition-all">
                        ✅ Öğrenci Modu
                    </button>
                </div>

                <div class="mt-8 p-4 bg-blue-50 rounded-xl">
                    <p class="text-sm text-gray-700">
                        <strong>🔐 Güvenlik Özellikleri:</strong><br/>
                        • Dinamik QR kod (30 sn yenilenir)<br/>
                        • Zaman sınırlı geçerlilik<br/>
                        • Tekrarlı yoklama engelleme<br/>
                        • GPS konum kontrolü<br/>
                        • Cihaz parmak izi kontrolü
                    </p>
                </div>

                <div class="mt-4 p-3 bg-yellow-50 rounded-xl">
                    <p class="text-xs text-gray-600">
                        <strong>💡 İpucu:</strong> QR kod paylaşılsa bile sadece sınıfta olanlar yoklama verebilir
                    </p>
                </div>
            </div>
        </div>
    </div>

    <!-- Şifre Modal -->
    <div id="passwordModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50">
        <div class="bg-white rounded-2xl shadow-2xl p-8 max-w-md w-full">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">🔐 Öğretmen Girişi</h2>
                <button onclick="closePasswordModal()" class="text-gray-500 hover:text-gray-700 text-2xl">
                    ×
                </button>
            </div>
            
            <div class="space-y-4">
                <div>
                    <label class="block text-gray-700 font-semibold mb-2">
                        Şifre
                    </label>
                    <input
                        type="password"
                        id="teacherPassword"
                        placeholder="Öğretmen şifrenizi girin"
                        class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-purple-500 focus:outline-none"
                    />
                    <p id="passwordError" class="text-red-500 text-sm mt-2 hidden">
                        ❌ Şifre yanlış! Lütfen tekrar deneyin.
                    </p>
                </div>
                
                <button onclick="verifyPassword()" class="w-full bg-gradient-to-r from-purple-500 to-indigo-600 text-white py-3 rounded-xl font-bold hover:shadow-lg transition-all">
                    Giriş Yap
                </button>
            </div>
        </div>
    </div>

    <!-- Konum Seçim Modal -->
    <div id="locationModal" class="hidden fixed inset-0 bg-black bg-opacity-50 flex items-center justify-center p-4 z-50 overflow-y-auto">
        <div class="bg-white rounded-2xl shadow-2xl p-6 max-w-4xl w-full my-8 max-h-[90vh] overflow-y-auto">
            <div class="flex justify-between items-center mb-6">
                <h2 class="text-2xl font-bold text-gray-800">📍 Konum Seçimi</h2>
                <button onclick="closeLocationModal()" class="text-gray-500 hover:text-gray-700 text-2xl">
                    ×
                </button>
            </div>
            
            <!-- Konum Seçim Metodları -->
            <div class="grid grid-cols-1 md:grid-cols-3 gap-3 mb-6">
                <button onclick="switchLocationMethod('auto')" id="btn-auto" class="location-method-btn bg-blue-100 border-2 border-blue-500 text-blue-700 py-3 rounded-xl font-semibold hover:bg-blue-200 transition-all">
                    🌐 Otomatik GPS
                </button>
                <button onclick="switchLocationMethod('manual')" id="btn-manual" class="location-method-btn bg-gray-100 border-2 border-gray-300 text-gray-700 py-3 rounded-xl font-semibold hover:bg-gray-200 transition-all">
                    ✏️ Manuel Giriş
                </button>
                <button onclick="switchLocationMethod('map')" id="btn-map" class="location-method-btn bg-gray-100 border-2 border-gray-300 text-gray-700 py-3 rounded-xl font-semibold hover:bg-gray-200 transition-all">
                    🗺️ Harita
                </button>
            </div>

            <!-- Otomatik GPS -->
            <div id="method-auto" class="location-method hidden">
                <div class="bg-blue-50 p-6 rounded-xl">
                    <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <span>🌐</span> Otomatik Konum Algılama
                    </h3>
                    <button onclick="getAutoLocation()" class="w-full bg-blue-600 text-white py-3 rounded-lg hover:bg-blue-700 font-semibold mb-4">
                        📍 Konumu Al
                    </button>
                    <div id="autoLocationStatus" class="text-sm text-gray-600">
                        Konumunuz otomatik olarak alınacak
                    </div>
                    <div id="autoLocationResult" class="hidden mt-4 p-4 bg-white rounded-lg">
                        <p class="text-sm"><strong>Enlem:</strong> <span id="autoLat">-</span></p>
                        <p class="text-sm"><strong>Boylam:</strong> <span id="autoLng">-</span></p>
                        <p class="text-sm"><strong>Doğruluk:</strong> <span id="autoAcc">-</span></p>
                    </div>
                </div>
            </div>

            <!-- Manuel Giriş -->
            <div id="method-manual" class="location-method hidden">
                <div class="bg-orange-50 p-6 rounded-xl">
                    <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <span>✏️</span> Manuel Konum Girişi
                    </h3>
                    <div class="space-y-4">
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">
                                Enlem (Latitude)
                            </label>
                            <input
                                type="number"
                                step="0.000001"
                                id="manualLat"
                                placeholder="Örn: 37.0000"
                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:outline-none"
                            />
                        </div>
                        <div>
                            <label class="block text-gray-700 font-semibold mb-2">
                                Boylam (Longitude)
                            </label>
                            <input
                                type="number"
                                step="0.000001"
                                id="manualLng"
                                placeholder="Örn: 35.3213"
                                class="w-full px-4 py-2 border-2 border-gray-300 rounded-lg focus:border-orange-500 focus:outline-none"
                            />
                        </div>
                        <div class="bg-blue-50 p-3 rounded-lg">
                            <p class="text-xs text-gray-700">
                                💡 <strong>İpucu:</strong> Google Maps'ten konum kopyalayabilirsiniz:<br/>
                                1. Google Maps'te konuma sağ tıklayın<br/>
                                2. İlk satırdaki koordinatları kopyalayın<br/>
                                3. Buraya yapıştırın
                            </p>
                        </div>
                        <button onclick="setManualLocation()" class="w-full bg-orange-600 text-white py-3 rounded-lg hover:bg-orange-700 font-semibold">
                            ✓ Konumu Kaydet
                        </button>
                    </div>
                </div>
            </div>

            <!-- Harita -->
            <div id="method-map" class="location-method hidden">
                <div class="bg-green-50 p-6 rounded-xl">
                    <h3 class="font-bold text-gray-800 mb-4 flex items-center gap-2">
                        <span>🗺️</span> Harita Üzerinden Seçim
                    </h3>
                    <p class="text-sm text-gray-600 mb-4">
                        Harita üzerinde bir noktaya tıklayarak konumu seçin
                    </p>
                    <div id="map" class="mb-4"></div>
                    <div id="mapSelectedLocation" class="hidden bg-white p-4 rounded-lg mb-4">
                        <p class="text-sm"><strong>Seçilen Konum:</strong></p>
                        <p class="text-sm">Enlem: <span id="mapLat">-</span></p>
                        <p class="text-sm">Boylam: <span id="mapLng">-</span></p>
                    </div>
                    <button onclick="setMapLocation()" id="mapConfirmBtn" class="w-full bg-green-600 text-white py-3 rounded-lg hover:bg-green-700 font-semibold" disabled>
                        ✓ Bu Konumu Kullan
                    </button>
                </div>
            </div>

            <!-- Kayıtlı Konumlar -->
            <div class="mt-6 bg-purple-50 p-4 rounded-xl">
                <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                    <span>💾</span> Kayıtlı Konumlar
                </h3>
                <div id="savedLocationsList" class="space-y-2 mb-3">
                    <!-- Kayıtlı konumlar buraya eklenecek -->
                </div>
                <button onclick="showSaveLocationDialog()" class="w-full bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700 text-sm">
                    + Mevcut Konumu Kaydet
                </button>
            </div>
        </div>
    </div>

    <!-- Öğretmen Modu Ekranı -->
    <div id="teacherScreen" class="hidden min-h-screen p-4">
        <div class="max-w-4xl mx-auto">
            <div class="bg-white rounded-3xl shadow-2xl p-6">
                <div class="flex items-center justify-between mb-6">
                    <h1 class="text-2xl font-bold text-gray-800">
                        📝 Öğretmen Paneli
                    </h1>
                    <button onclick="showSelectScreen()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                        ← Geri
                    </button>
                </div>

                <div id="teacherLoading" class="text-center py-12">
                    <div class="animate-spin rounded-full h-12 w-12 border-b-2 border-purple-600 mx-auto mb-4"></div>
                    <p class="text-gray-600">QR kod oluşturuluyor...</p>
                </div>

                <div id="teacherContent" class="hidden">
                    <!-- Ders Bilgisi -->
                    <div class="bg-gradient-to-br from-blue-50 to-indigo-50 p-4 rounded-2xl mb-4">
                        <label class="block text-gray-700 font-semibold mb-2">
                            Ders Adı
                        </label>
                        <input
                            type="text"
                            id="courseName"
                            placeholder="Örn: Matematik 101"
                            class="w-full px-4 py-2 border-2 border-gray-300 rounded-xl focus:border-blue-500 focus:outline-none"
                        />
                    </div>

                    <!-- Güvenlik Ayarları -->
                    <div class="bg-gradient-to-br from-orange-50 to-red-50 p-4 rounded-2xl mb-4">
                        <h3 class="font-bold text-gray-800 mb-3 flex items-center gap-2">
                            <span>🔐</span> Güvenlik Ayarları
                        </h3>
                        <div class="grid grid-cols-2 gap-3">
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">QR Yenileme (saniye)</label>
                                <select id="qrRefreshTime" class="w-full px-3 py-2 border rounded-lg text-sm" onchange="restartQRRefresh()">
                                    <option value="30">30 saniye</option>
                                    <option value="60">60 saniye</option>
                                    <option value="120">120 saniye</option>
                                    <option value="0">Otomatik kapalı</option>
                                </select>
                            </div>
                            <div>
                                <label class="block text-xs text-gray-600 mb-1">QR Geçerlilik (dk)</label>
                                <select id="qrValidityTime" class="w-full px-3 py-2 border rounded-lg text-sm">
                                    <option value="2">2 dakika</option>
                                    <option value="5" selected>5 dakika</option>
                                    <option value="10">10 dakika</option>
                                    <option value="15">15 dakika</option>
                                </select>
                            </div>
                        </div>
                        <div class="mt-3">
                            <label class="flex items-center gap-2 text-sm">
                                <input type="checkbox" id="preventDuplicate" checked class="rounded">
                                <span class="text-gray-700">Aynı kişiden tekrar yoklama alma</span>
                            </label>
                        </div>
                    </div>

                    <div class="bg-gradient-to-br from-purple-50 to-indigo-50 p-6 rounded-2xl mb-6">
                        <div class="flex items-center justify-between mb-4">
                            <h2 class="text-xl font-bold text-gray-800">
                                Yoklama QR Kodu
                            </h2>
                            <div class="flex items-center gap-2" id="qrStatus">
                                <span class="animate-pulse text-green-600 text-sm">🔴 Canlı</span>
                            </div>
                        </div>
                        
                        <!-- QR Kod Countdown -->
                        <div class="mb-2 bg-gray-200 rounded-full h-2 overflow-hidden">
                            <div id="qrCountdown" class="countdown-bar h-full bg-gradient-to-r from-green-500 to-blue-500"></div>
                        </div>
                        <p class="text-center text-xs text-gray-600 mb-4" id="qrTimeRemaining">
                            Otomatik yenileme: --
                        </p>
                        
                        <div id="qrcode" class="bg-white p-6 rounded-xl shadow-lg"></div>
                        <p class="text-center mt-4 text-sm text-gray-600">
                            Öğrenciler bu kodu okutarak yoklama verebilir
                        </p>
                        <p class="text-center text-xs text-orange-600 mt-2" id="qrExpireTime">
                            ⏱️ QR kod geçerlilik süresi: --
                        </p>
                        <button onclick="manualRefreshQR()" class="w-full mt-4 bg-purple-600 text-white py-2 rounded-lg hover:bg-purple-700">
                            🔄 Hemen Yenile
                        </button>
                    </div>

                    <div class="bg-blue-50 p-4 rounded-xl mb-6">
                        <div class="flex items-center justify-between mb-2">
                            <div class="flex items-center gap-2">
                                <span class="text-2xl">📍</span>
                                <span class="font-semibold text-gray-800">Sınıf Konumu:</span>
                            </div>
                            <button onclick="showLocationModal()" class="bg-blue-600 text-white px-3 py-1 rounded-lg hover:bg-blue-700 text-sm flex items-center gap-1">
                                🔄 Konumu Değiştir
                            </button>
                        </div>
                        <p class="text-sm text-gray-700" id="teacherLocation">
                            Konum alınıyor...
                        </p>
                        <p class="text-xs text-gray-500 mt-1" id="locationTime"></p>
                        <div class="mt-2">
                            <span id="connectionStatus" class="text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded">
                                🔌 Bağlantı durumu kontrol ediliyor...
                            </span>
                        </div>
                    </div>

                    <div class="bg-green-50 p-4 rounded-xl">
                        <div class="flex items-center justify-between mb-4">
                            <div class="flex items-center gap-2">
                                <span class="text-2xl">👥</span>
                                <span class="font-bold text-gray-800">Yoklama Listesi</span>
                            </div>
                            <span id="attendanceCount" class="bg-green-600 text-white px-3 py-1 rounded-full text-sm font-bold">
                                0
                            </span>
                        </div>
                        
                        <div id="attendanceList" class="space-y-2 max-h-96 overflow-y-auto">
                            <p class="text-center text-gray-500 py-4">
                                Henüz yoklama yok
                            </p>
                        </div>

                        <div class="grid grid-cols-2 gap-3 mt-4">
                            <button onclick="downloadExcel()" class="bg-blue-600 text-white py-2 rounded-lg hover:bg-blue-700 flex items-center justify-center gap-2">
                                <span>📊</span> Excel İndir
                            </button>
                            <button onclick="downloadCSV()" class="bg-teal-600 text-white py-2 rounded-lg hover:bg-teal-700 flex items-center justify-center gap-2">
                                <span>📄</span> CSV İndir
                            </button>
                        </div>

                        <button onclick="clearAttendance()" class="w-full mt-3 bg-red-500 text-white py-2 rounded-lg hover:bg-red-600">
                            🗑️ Listeyi Temizle
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <!-- Öğrenci Modu Ekranı -->
    <div id="studentScreen" class="hidden min-h-screen p-4">
        <div class="max-w-md mx-auto">
            <div class="bg-white rounded-3xl shadow-2xl p-6">
                <div class="flex items-center justify-between mb-6">
                    <h1 class="text-2xl font-bold text-gray-800">
                        ✅ Öğrenci Paneli
                    </h1>
                    <button onclick="showSelectScreen()" class="bg-gray-500 text-white px-4 py-2 rounded-lg hover:bg-gray-600">
                        ← Geri
                    </button>
                </div>

                <div class="space-y-4 mb-6">
                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">
                            Adınız Soyadınız
                        </label>
                        <input
                            type="text"
                            id="studentName"
                            placeholder="Örn: Ahmet Yılmaz"
                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-green-500 focus:outline-none"
                        />
                    </div>

                    <div>
                        <label class="block text-gray-700 font-semibold mb-2">
                            Öğrenci Numarası (Opsiyonel)
                        </label>
                        <input
                            type="text"
                            id="studentNumber"
                            placeholder="Örn: 20240001"
                            class="w-full px-4 py-3 border-2 border-gray-300 rounded-xl focus:border-green-500 focus:outline-none"
                        />
                    </div>

                    <button onclick="startQRScanner()" class="w-full bg-gradient-to-r from-green-500 to-emerald-600 text-white py-4 rounded-xl font-bold text-lg hover:shadow-xl transform hover:scale-105 transition-all">
                        📷 QR Kod Okut
                    </button>
                </div>

                <!-- Kamera Görüntüsü -->
                <div id="scannerContainer" class="hidden mb-6">
                    <div class="relative bg-black rounded-xl overflow-hidden">
                        <video id="video" class="w-full" autoplay playsinline></video>
                        <canvas id="canvas" class="hidden"></canvas>
                        <div class="absolute inset-0 border-4 border-green-400 pointer-events-none"></div>
                        <div class="absolute top-4 left-4 right-4 bg-green-500/80 text-white px-4 py-2 rounded-lg text-center font-bold">
                            QR kodu kamera ile tarayın
                        </div>
                    </div>
                    <button onclick="stopQRScanner()" class="w-full mt-4 bg-red-500 text-white py-2 rounded-lg hover:bg-red-600">
                        ❌ İptal
                    </button>
                </div>

                <!-- Sonuç Mesajı -->
                <div id="scanResult" class="hidden"></div>

                <div class="mt-6 p-4 bg-blue-50 rounded-xl">
                    <p class="text-sm text-gray-700">
                        <strong>ℹ️ Bilgi:</strong><br/>
                        • Adınızı girip QR kodu okutun<br/>
                        • Sınıfın 50m içinde olmalısınız<br/>
                        • Yoklamanız otomatik kaydedilir<br/>
                        • Her öğrenci sadece 1 kez yoklama verebilir
                    </p>
                </div>

                <div class="mt-4 p-3 bg-orange-50 rounded-xl">
                    <p class="text-xs text-gray-600">
                        <strong>⚠️ Uyarı:</strong> GPS sahteciliği tespit edilirse yoklamanız geçersiz sayılacaktır.
                    </p>
                </div>
            </div>
        </div>
    </div>

    <script>
        // ============================================
        // GÜVENLİK AYARLARI
        // ============================================
        const TEACHER_PASSWORD = "ogretmen123";
        let qrRefreshInterval = null;
        let qrCountdownInterval = null;
        let currentLocation = null;
        let map = null;
        let mapMarker = null;
        let selectedMapLocation = null;
        let currentLocationMethod = 'auto';

        // Cihaz parmak izi oluştur
        function getDeviceFingerprint() {
            const canvas = document.createElement('canvas');
            const ctx = canvas.getContext('2d');
            ctx.textBaseline = 'top';
            ctx.font = '14px Arial';
            ctx.fillText('Browser fingerprint', 2, 2);
            
            return canvas.toDataURL() + 
                   navigator.userAgent + 
                   navigator.language + 
                   screen.width + 'x' + screen.height +
                   new Date().getTimezoneOffset();
        }

        // Basit hash fonksiyonu
        function simpleHash(str) {
            let hash = 0;
            for (let i = 0; i < str.length; i++) {
                const char = str.charCodeAt(i);
                hash = ((hash << 5) - hash) + char;
                hash = hash & hash;
            }
            return Math.abs(hash).toString(36);
        }

        const deviceId = simpleHash(getDeviceFingerprint());

        // ============================================
        // KONUM YÖNETİMİ
        // ============================================

        // Konum modalını aç
        function showLocationModal() {
            document.getElementById('locationModal').classList.remove('hidden');
            switchLocationMethod('auto');
            loadSavedLocations();
        }

        // Konum modalını kapat
        function closeLocationModal() {
            document.getElementById('locationModal').classList.add('hidden');
        }

        // Konum yöntemi değiştir
        function switchLocationMethod(method) {
            currentLocationMethod = method;
            
            // Tüm butonları gri yap
            document.querySelectorAll('.location-method-btn').forEach(btn => {
                btn.className = 'location-method-btn bg-gray-100 border-2 border-gray-300 text-gray-700 py-3 rounded-xl font-semibold hover:bg-gray-200 transition-all';
            });
            
            // Aktif butonu vurgula
            const activeBtn = document.getElementById('btn-' + method);
            if (activeBtn) {
                if (method === 'auto') {
                    activeBtn.className = 'location-method-btn bg-blue-100 border-2 border-blue-500 text-blue-700 py-3 rounded-xl font-semibold hover:bg-blue-200 transition-all';
                } else if (method === 'manual') {
                    activeBtn.className = 'location-method-btn bg-orange-100 border-2 border-orange-500 text-orange-700 py-3 rounded-xl font-semibold hover:bg-orange-200 transition-all';
                } else if (method === 'map') {
                    activeBtn.className = 'location-method-btn bg-green-100 border-2 border-green-500 text-green-700 py-3 rounded-xl font-semibold hover:bg-green-200 transition-all';
                }
            }
            
            // Tüm method div'lerini gizle
            document.querySelectorAll('.location-method').forEach(div => {
                div.classList.add('hidden');
            });
            
            // Seçili method'u göster
            const activeMethod = document.getElementById('method-' + method);
            if (activeMethod) {
                activeMethod.classList.remove('hidden');
            }
            
            // Harita metoduysa haritayı başlat
            if (method === 'map' && !map) {
                setTimeout(initMap, 100);
            }
        }

        // Otomatik konum al
        function getAutoLocation() {
            const statusEl = document.getElementById('autoLocationStatus');
            statusEl.innerHTML = '<span class="text-blue-600 animate-pulse">📍 Konum alınıyor...</span>';
            
            if (!navigator.geolocation) {
                statusEl.innerHTML = '<span class="text-red-600">❌ Tarayıcınız konum özelliğini desteklemiyor!</span>';
                return;
            }

            navigator.geolocation.getCurrentPosition(
                (position) => {
                    const location = {
                        lat: position.coords.latitude,
                        lng: position.coords.longitude,
                        accuracy: position.coords.accuracy
                    };
                    
                    document.getElementById('autoLat').textContent = location.lat.toFixed(6);
                    document.getElementById('autoLng').textContent = location.lng.toFixed(6);
                    document.getElementById('autoAcc').textContent = '±' + location.accuracy.toFixed(0) + 'm';
                    document.getElementById('autoLocationResult').classList.remove('hidden');
                    
                    statusEl.innerHTML = '<span class="text-green-600">✅ Konum başarıyla alındı!</span>';
                    
                    // Konumu kaydet
                    setLocation(location, 'Otomatik GPS');
                },
                (error) => {
                    let errorMessage = 'Konum alınamadı! ';
                    switch(error.code) {
                        case error.PERMISSION_DENIED:
                            errorMessage += 'Konum izni verilmedi.';
                            break;
                        case error.POSITION_UNAVAILABLE:
                            errorMessage += 'Konum bilgisi kullanılamıyor.';
                            break;
                        case error.TIMEOUT:
                            errorMessage += 'Zaman aşımı.';
                            break;
                        default:
                            errorMessage += 'Bilinmeyen hata.';
                    }
                    statusEl.innerHTML = `<span class="text-red-600">❌ ${errorMessage}</span>`;
                },
                {
                    enableHighAccuracy: true,
                    timeout: 10000,
                    maximumAge: 0
                }
            );
        }

        // Manuel konum kaydet
        function setManualLocation() {
            const lat = parseFloat(document.getElementById('manualLat').value);
            const lng = parseFloat(document.getElementById('manualLng').value);
            
            if (isNaN(lat) || isNaN(lng)) {
                alert('Lütfen geçerli enlem ve boylam değerleri girin!');
                return;
            }
            
            if (lat < -90 || lat > 90 || lng < -180 || lng > 180) {
                alert('Geçersiz koordinatlar! Enlem -90 ile 90, Boylam -180 ile 180 arasında olmalı.');
                return;
            }
            
            const location = {
                lat: lat,
                lng: lng,
                accuracy: 10 // Manuel girişte varsayılan doğruluk
            };
            
            setLocation(location, 'Manuel Giriş');
        }

        // Harita başlat
        function initMap() {
            if (map) return;
            
            // Varsayılan konum: Türkiye merkezi
            const defaultLat = currentLocation ? currentLocation.lat : 39.9334;
            const defaultLng = currentLocation ? currentLocation.lng : 32.8597;
            
            map = L.map('map').setView([defaultLat, defaultLng], 13);
            
            L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
                attribution: '© OpenStreetMap contributors'
            }).addTo(map);
            
            // Haritaya tıklanınca marker ekle
            map.on('click', function(e) {
                if (mapMarker) {
                    map.removeLayer(mapMarker);
                }
                
                mapMarker = L.marker([e.latlng.lat, e.latlng.lng]).addTo(map);
                selectedMapLocation = {
                    lat: e.latlng.lat,
                    lng: e.latlng.lng,
                    accuracy: 10
                };
                
                document.getElementById('mapLat').textContent = e.latlng.lat.toFixed(6);
                document.getElementById('mapLng').textContent = e.latlng.lng.toFixed(6);
                document.getElementById('mapSelectedLocation').classList.remove('hidden');
                document.getElementById('mapConfirmBtn').disabled = false;
            });
        }

        // Harita konumunu kaydet
        function setMapLocation() {
            if (!selectedMapLocation) {
                alert('Lütfen harita üzerinde bir konum seçin!');
                return;
            }
            
            setLocation(selectedMapLocation, 'Harita Seçimi');
        }

        // Konumu ayarla ve modalı kapat
        function setLocation(location, source) {
            currentLocation = location;
            updateLocationDisplay(currentLocation, source);
            closeLocationModal();
            
            // QR kodu yenile
            if (document.getElementById('teacherContent').classList.contains('hidden') === false) {
                generateQRCode(currentLocation);
                showNotification('✅ Konum güncellendi! Yeni QR kod oluşturuldu.', 'success');
            }
        }

        // Kayıtlı konumları yükle
        function loadSavedLocations() {
            const saved = JSON.parse(localStorage.getItem('savedLocations') || '[]');
            const container = document.getElementById('savedLocationsList');
            
            if (saved.length === 0) {
                container.innerHTML = '<p class="text-sm text-gray-500 text-center py-2">Henüz kayıtlı konum yok</p>';
            } else {
                container.innerHTML = saved.map((loc, idx) => `
                    <div class="flex items-center justify-between bg-white p-3 rounded-lg">
                        <div class="flex-1">
                            <p class="font-semibold text-sm text-gray-800">${loc.name}</p>
                            <p class="text-xs text-gray-500">${loc.lat.toFixed(4)}, ${loc.lng.toFixed(4)}</p>
                        </div>
                        <div class="flex gap-2">
                            <button onclick="useSavedLocation(${idx})" class="bg-purple-600 text-white px-3 py-1 rounded text-xs hover:bg-purple-700">
                                Kullan
                            </button>
                            <button onclick="deleteSavedLocation(${idx})" class="bg-red-500 text-white px-3 py-1 rounded text-xs hover:bg-red-600">
                                Sil
                            </button>
                        </div>
                    </div>
                `).join('');
            }
        }

        // Kayıtlı konum kullan
        function useSavedLocation(index) {
            const saved = JSON.parse(localStorage.getItem('savedLocations') || '[]');
            if (saved[index]) {
                setLocation(saved[index], 'Kayıtlı Konum: ' + saved[index].name);
            }
        }

        // Kayıtlı konum sil
        function deleteSavedLocation(index) {
            if (confirm('Bu konumu silmek istediğinizden emin misiniz?')) {
                const saved = JSON.parse(localStorage.getItem('savedLocations') || '[]');
                saved.splice(index, 1);
                localStorage.setItem('savedLocations', JSON.stringify(saved));
                loadSavedLocations();
            }
        }

        // Konum kaydetme dialogu
        function showSaveLocationDialog() {
            if (!currentLocation) {
                alert('Önce bir konum seçin!');
                return;
            }
            
            const name = prompt('Bu konum için bir isim girin (Örn: A101 Sınıfı):');
            if (name && name.trim()) {
                const saved = JSON.parse(localStorage.getItem('savedLocations') || '[]');
                saved.push({
                    name: name.trim(),
                    lat: currentLocation.lat,
                    lng: currentLocation.lng,
                    accuracy: currentLocation.accuracy
                });
                localStorage.setItem('savedLocations', JSON.stringify(saved));
                loadSavedLocations();
                showNotification('✅ Konum kaydedildi!', 'success');
            }
        }

        // Konum görüntüsünü güncelle
        function updateLocationDisplay(location, source) {
            const now = new Date().toLocaleString('tr-TR');
            document.getElementById('teacherLocation').innerHTML = `
                <span class="text-green-700 font-semibold">✅ Aktif</span> ${source ? `<span class="text-xs text-gray-500">(${source})</span>` : ''}<br/>
                <span class="text-gray-700">Enlem: ${location.lat.toFixed(6)}</span><br/>
                <span class="text-gray-700">Boylam: ${location.lng.toFixed(6)}</span><br/>
                <span class="text-xs text-gray-500">Doğruluk: ±${location.accuracy.toFixed(0)}m</span>
            `;
            document.getElementById('locationTime').textContent = `Son güncelleme: ${now}`;
        }

        // ============================================
        // ŞİFRE MODALINI AÇ/KAPAT
        // ============================================
        
        function showTeacherPasswordModal() {
            document.getElementById('passwordModal').classList.remove('hidden');
            document.getElementById('teacherPassword').value = '';
            document.getElementById('passwordError').classList.add('hidden');
            setTimeout(() => {
                document.getElementById('teacherPassword').focus();
            }, 100);
        }

        function closePasswordModal() {
            document.getElementById('passwordModal').classList.add('hidden');
        }

        function verifyPassword() {
            const password = document.getElementById('teacherPassword').value;
            const errorMsg = document.getElementById('passwordError');
            
            if (password === TEACHER_PASSWORD) {
                closePasswordModal();
                showTeacherMode();
            } else {
                errorMsg.classList.remove('hidden');
                document.getElementById('teacherPassword').value = '';
                document.getElementById('teacherPassword').focus();
                
                setTimeout(() => {
                    errorMsg.classList.add('hidden');
                }, 3000);
            }
        }

        // Enter tuşu ile şifre girişi
        document.addEventListener('DOMContentLoaded', function() {
            const passwordInput = document.getElementById('teacherPassword');
            if (passwordInput) {
                passwordInput.addEventListener('keypress', function(e) {
                    if (e.key === 'Enter') {
                        verifyPassword();
                    }
                });
            }
        });

        // Modal dışına tıklanınca kapat
        document.getElementById('passwordModal')?.addEventListener('click', function(e) {
            if (e.target.id === 'passwordModal') {
                closePasswordModal();
            }
        });

        document.getElementById('locationModal')?.addEventListener('click', function(e) {
            if (e.target.id === 'locationModal') {
                closeLocationModal();
            }
        });

        // ============================================
        // FIREBASE YAPLANDIRMASI
        // ============================================
        const firebaseConfig = {
            apiKey: "AIzaSyDHILOLgcQ6WU--hjO8qd__7ApN_-4Jm3w",
            authDomain: "qr-yoklama-sistemi-f54f5.firebaseapp.com",
            databaseURL: "https://qr-yoklama-sistemi-f54f5-default-rtdb.europe-west1.firebasedatabase.app",
            projectId: "qr-yoklama-sistemi-f54f5",
            storageBucket: "qr-yoklama-sistemi-f54f5.firebasestorage.app",
            messagingSenderId: "431067742021",
            appId: "1:431067742021:web:784c0ad599aab659fa882c"
        };

        let database;
        let useFirebase = false;

        try {
            firebase.initializeApp(firebaseConfig);
            database = firebase.database();
            useFirebase = true;
            updateConnectionStatus('✅ Bulut bağlantısı aktif');
        } catch (error) {
            console.log('Firebase bağlantısı kurulamadı, localStorage kullanılacak');
            useFirebase = false;
            updateConnectionStatus('⚠️ Yerel depolama kullanılıyor');
        }

        function updateConnectionStatus(message) {
            const statusEl = document.getElementById('connectionStatus');
            if (statusEl) {
                statusEl.textContent = message;
                if (message.includes('✅')) {
                    statusEl.className = 'text-xs bg-green-200 text-green-800 px-2 py-1 rounded';
                } else if (message.includes('⚠️')) {
                    statusEl.className = 'text-xs bg-yellow-200 text-yellow-800 px-2 py-1 rounded';
                } else {
                    statusEl.className = 'text-xs bg-gray-200 text-gray-700 px-2 py-1 rounded';
                }
            }
        }

        let currentQRData = null;
        let videoStream = null;
        let scanInterval = null;
        let currentSessionId = null;

        // Ekran geçişleri
        function showSelectScreen() {
            document.getElementById('selectScreen').classList.remove('hidden');
            document.getElementById('teacherScreen').classList.add('hidden');
            document.getElementById('studentScreen').classList.add('hidden');
            stopQRScanner();
            stopQRRefresh();
        }

        function showTeacherMode() {
            document.getElementById('selectScreen').classList.add('hidden');
            document.getElementById('teacherScreen').classList.remove('hidden');
            document.getElementById('teacherLoading').classList.remove('hidden');
            document.getElementById('teacherContent').classList.add('hidden');
            
            setTimeout(() => {
                initTeacherMode();
            }, 500);
        }

        function showStudentMode() {
            document.getElementById('selectScreen').classList.add('hidden');
            document.getElementById('studentScreen').classList.remove('hidden');
        }

        // Öğretmen modu başlatma
        function initTeacherMode() {
            // Konum modal'ını göster
            showLocationModal();
            
            // Eğer konum daha önce alınmışsa direkt başlat
            if (currentLocation) {
                document.getElementById('teacherLoading').classList.add('hidden');
                document.getElementById('teacherContent').classList.remove('hidden');
                generateQRCode(currentLocation);
                loadAttendanceList();
                startQRRefresh();
                
                if (useFirebase && currentSessionId) {
                    listenToFirebaseUpdates();
                }
            } else {
                // Otomatik konum almayı dene
                getAutoLocation();
                setTimeout(() => {
                    if (currentLocation) {
                        closeLocationModal();
                        document.getElementById('teacherLoading').classList.add('hidden');
                        document.getElementById('teacherContent').classList.remove('hidden');
                        generateQRCode(currentLocation);
                        loadAttendanceList();
                        startQRRefresh();
                        
                        if (useFirebase && currentSessionId) {
                            listenToFirebaseUpdates();
                        }
                    }
                }, 2000);
            }
        }

        // QR otomatik yenileme başlat
        function startQRRefresh() {
            stopQRRefresh();
            
            const refreshTime = parseInt(document.getElementById('qrRefreshTime').value);
            if (refreshTime === 0) {
                document.getElementById('qrTimeRemaining').textContent = 'Otomatik yenileme: Kapalı';
                return;
            }

            let remainingTime = refreshTime;
            const countdownBar = document.getElementById('qrCountdown');
            countdownBar.style.setProperty('--duration', refreshTime + 's');
            countdownBar.style.width = '100%';
            
            setTimeout(() => {
                countdownBar.classList.add('countdown-bar');
            }, 10);

            qrCountdownInterval = setInterval(() => {
                remainingTime--;
                document.getElementById('qrTimeRemaining').textContent = 
                    `Otomatik yenileme: ${remainingTime} saniye`;
                
                if (remainingTime <= 0) {
                    manualRefreshQR();
                }
            }, 1000);

            qrRefreshInterval = setInterval(() => {
                if (currentLocation) {
                    generateQRCode(currentLocation);
                    remainingTime = refreshTime;
                    
                    countdownBar.classList.remove('countdown-bar');
                    countdownBar.style.width = '100%';
                    setTimeout(() => {
                        countdownBar.classList.add('countdown-bar');
                    }, 10);
                }
            }, refreshTime * 1000);
        }

        function stopQRRefresh() {
            if (qrRefreshInterval) {
                clearInterval(qrRefreshInterval);
                qrRefreshInterval = null;
            }
            if (qrCountdownInterval) {
                clearInterval(qrCountdownInterval);
                qrCountdownInterval = null;
            }
        }

        function restartQRRefresh() {
            startQRRefresh();
        }

        function manualRefreshQR() {
            if (currentLocation) {
                generateQRCode(currentLocation);
                stopQRRefresh();
                startQRRefresh();
                showNotification('✅ QR kod yenilendi!', 'success');
            }
        }

        function listenToFirebaseUpdates() {
            if (!useFirebase || !currentSessionId) return;

            const sessionRef = database.ref('sessions/' + currentSessionId + '/attendances');
            sessionRef.on('value', (snapshot) => {
                loadAttendanceList();
            });
        }

        function generateQRCode(location) {
            const timestamp = Date.now();
            currentSessionId = 'session_' + timestamp;
            
            const validityMinutes = parseInt(document.getElementById('qrValidityTime').value);
            const expiryTime = timestamp + (validityMinutes * 60 * 1000);
            
            const qrData = {
                type: 'attendance',
                sessionId: currentSessionId,
                location: location,
                radius: 50,
                timestamp: timestamp,
                expiryTime: expiryTime,
                randomToken: Math.random().toString(36).substring(7)
            };
            
            currentQRData = qrData;
            
            const qrcodeDiv = document.getElementById('qrcode');
            qrcodeDiv.innerHTML = '';
            
            new QRCode(qrcodeDiv, {
                text: JSON.stringify(qrData),
                width: 256,
                height: 256,
                colorDark: '#000000',
                colorLight: '#ffffff',
                correctLevel: QRCode.CorrectLevel.H
            });

            const expiryDate = new Date(expiryTime);
            document.getElementById('qrExpireTime').textContent = 
                `⏱️ QR kod şu saate kadar geçerli: ${expiryDate.toLocaleTimeString('tr-TR')}`;

            if (useFirebase) {
                database.ref('sessions/' + currentSessionId).set({
                    createdAt: firebase.database.ServerValue.TIMESTAMP,
                    expiryTime: expiryTime,
                    location: location,
                    courseName: document.getElementById('courseName')?.value || 'Belirtilmemiş'
                });
            }
        }

        function calculateDistance(lat1, lon1, lat2, lon2) {
            const R = 6371e3;
            const φ1 = lat1 * Math.PI / 180;
            const φ2 = lat2 * Math.PI / 180;
            const Δφ = (lat2 - lat1) * Math.PI / 180;
            const Δλ = (lon2 - lon1) * Math.PI / 180;

            const a = Math.sin(Δφ / 2) * Math.sin(Δφ / 2) +
                    Math.cos(φ1) * Math.cos(φ2) *
                    Math.sin(Δλ / 2) * Math.sin(Δλ / 2);
            const c = 2 * Math.atan2(Math.sqrt(a), Math.sqrt(1 - a));

            return R * c;
        }

        async function startQRScanner() {
            const studentName = document.getElementById('studentName').value.trim();
            
            if (!studentName) {
                alert('Lütfen adınızı soyadınızı girin!');
                return;
            }
            
            document.getElementById('scannerContainer').classList.remove('hidden');
            document.getElementById('scanResult').classList.add('hidden');
            
            try {
                videoStream = await navigator.mediaDevices.getUserMedia({
                    video: { facingMode: 'environment' }
                });
                
                const video = document.getElementById('video');
                video.srcObject = videoStream;
                video.play();
                
                scanInterval = setInterval(scanQRCode, 300);
            } catch (err) {
                alert('Kamera erişimi reddedildi!');
                stopQRScanner();
            }
        }

        function scanQRCode() {
            const video = document.getElementById('video');
            const canvas = document.getElementById('canvas');
            const ctx = canvas.getContext('2d');
            
            if (video.readyState === video.HAVE_ENOUGH_DATA) {
                canvas.width = video.videoWidth;
                canvas.height = video.videoHeight;
                ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
                
                const imageData = ctx.getImageData(0, 0, canvas.width, canvas.height);
                const code = jsQR(imageData.data, imageData.width, imageData.height);
                
                if (code) {
                    processQRCode(code.data);
                }
            }
        }

        function processQRCode(qrData) {
            stopQRScanner();
            
            try {
                const qrContent = JSON.parse(qrData);
                
                const now = Date.now();
                if (now > qrContent.expiryTime) {
                    showResult('expired', null);
                    return;
                }
                
                const studentName = document.getElementById('studentName').value.trim();
                const studentNumber = document.getElementById('studentNumber').value.trim();
                
                if (navigator.geolocation) {
                    navigator.geolocation.getCurrentPosition(
                        (position) => {
                            const studentLoc = {
                                lat: position.coords.latitude,
                                lng: position.coords.longitude,
                                accuracy: position.coords.accuracy
                            };
                            
                            const distance = calculateDistance(
                                studentLoc.lat,
                                studentLoc.lng,
                                qrContent.location.lat,
                                qrContent.location.lng
                            );
                            
                            if (distance > qrContent.radius) {
                                showResult('out_of_range', distance.toFixed(0));
                                return;
                            }
                            
                            checkDuplicateAttendance(studentName, studentNumber, qrContent.sessionId, (isDuplicate) => {
                                if (isDuplicate) {
                                    showResult('duplicate', distance.toFixed(0));
                                    return;
                                }
                                
                                const attendance = {
                                    name: studentName,
                                    studentNumber: studentNumber || 'Belirtilmemiş',
                                    time: new Date().toLocaleString('tr-TR'),
                                    timestamp: Date.now(),
                                    distance: distance.toFixed(0),
                                    sessionId: qrContent.sessionId,
                                    location: studentLoc,
                                    deviceId: deviceId,
                                    accuracy: studentLoc.accuracy
                                };
                                
                                saveAttendance(attendance);
                                showResult('success', distance.toFixed(0));
                            });
                        },
                        (error) => {
                            alert('Konum erişimi reddedildi!');
                        },
                        {
                            enableHighAccuracy: true,
                            timeout: 10000,
                            maximumAge: 0
                        }
                    );
                }
            } catch (err) {
                alert('Geçersiz QR kod!');
            }
        }

        function checkDuplicateAttendance(name, number, sessionId, callback) {
            const preventDuplicate = document.getElementById('preventDuplicate')?.checked !== false;
            
            if (!preventDuplicate) {
                callback(false);
                return;
            }
            
            if (useFirebase) {
                database.ref('sessions/' + sessionId + '/attendances').once('value', (snapshot) => {
                    const data = snapshot.val();
                    if (data) {
                        const list = Object.values(data);
                        const isDuplicate = list.some(att => 
                            att.name === name || 
                            (number && att.studentNumber === number) ||
                            att.deviceId === deviceId
                        );
                        callback(isDuplicate);
                    } else {
                        callback(false);
                    }
                });
            } else {
                const list = JSON.parse(localStorage.getItem('attendanceList') || '[]');
                const isDuplicate = list.some(att => 
                    (att.sessionId === sessionId && att.name === name) ||
                    (number && att.sessionId === sessionId && att.studentNumber === number) ||
                    (att.sessionId === sessionId && att.deviceId === deviceId)
                );
                callback(isDuplicate);
            }
        }

        function showResult(status, distance) {
            const resultDiv = document.getElementById('scanResult');
            resultDiv.classList.remove('hidden');
            
            if (status === 'success') {
                resultDiv.innerHTML = `
                    <div class="p-4 rounded-xl mb-4 bg-green-50 border-2 border-green-500">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">✅</span>
                            <div>
                                <p class="font-bold text-green-800">Yoklama Başarılı!</p>
                                <p class="text-sm text-green-700">Mesafe: ${distance} metre</p>
                                <p class="text-xs text-green-600 mt-1">Kaydınız buluta yüklendi</p>
                            </div>
                        </div>
                    </div>
                `;
                document.getElementById('studentName').value = '';
                document.getElementById('studentNumber').value = '';
            } else if (status === 'expired') {
                resultDiv.innerHTML = `
                    <div class="p-4 rounded-xl mb-4 bg-orange-50 border-2 border-orange-500">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">⏱️</span>
                            <div>
                                <p class="font-bold text-orange-800">QR Kod Süresi Dolmuş!</p>
                                <p class="text-sm text-orange-700">Öğretmeninizden yeni QR kod isteyin.</p>
                            </div>
                        </div>
                    </div>
                `;
            } else if (status === 'duplicate') {
                resultDiv.innerHTML = `
                    <div class="p-4 rounded-xl mb-4 bg-yellow-50 border-2 border-yellow-500">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">⚠️</span>
                            <div>
                                <p class="font-bold text-yellow-800">Zaten Yoklama Verdiniz!</p>
                                <p class="text-sm text-yellow-700">Bu oturumda daha önce yoklama kaydınız var.</p>
                            </div>
                        </div>
                    </div>
                `;
            } else {
                resultDiv.innerHTML = `
                    <div class="p-4 rounded-xl mb-4 bg-red-50 border-2 border-red-500">
                        <div class="flex items-center gap-3">
                            <span class="text-3xl">❌</span>
                            <div>
                                <p class="font-bold text-red-800">Yoklama Başarısız!</p>
                                <p class="text-sm text-red-700">Sınıf dışındasınız!<br/>Mesafe: ${distance} metre (Max: 50m)</p>
                            </div>
                        </div>
                    </div>
                `;
            }
        }

        function stopQRScanner() {
            if (videoStream) {
                videoStream.getTracks().forEach(track => track.stop());
                videoStream = null;
            }
            if (scanInterval) {
                clearInterval(scanInterval);
                scanInterval = null;
            }
            document.getElementById('scannerContainer').classList.add('hidden');
        }

        function saveAttendance(attendance) {
            if (useFirebase) {
                const attendanceRef = database.ref('sessions/' + attendance.sessionId + '/attendances');
                attendanceRef.push(attendance);
            } else {
                let list = JSON.parse(localStorage.getItem('attendanceList') || '[]');
                list.push(attendance);
                localStorage.setItem('attendanceList', JSON.stringify(list));
            }
            loadAttendanceList();
        }

        function loadAttendanceList() {
            if (useFirebase && currentSessionId) {
                database.ref('sessions/' + currentSessionId + '/attendances').once('value', (snapshot) => {
                    const data = snapshot.val();
                    let list = [];
                    if (data) {
                        list = Object.values(data);
                    }
                    displayAttendanceList(list);
                });
            } else {
                const list = JSON.parse(localStorage.getItem('attendanceList') || '[]');
                displayAttendanceList(list);
            }
        }

        function displayAttendanceList(list) {
            const container = document.getElementById('attendanceList');
            const count = document.getElementById('attendanceCount');
            
            if (!container || !count) return;
            
            count.textContent = list.length;
            
            if (list.length === 0) {
                container.innerHTML = '<p class="text-center text-gray-500 py-4">Henüz yoklama yok</p>';
            } else {
                list.sort((a, b) => (b.timestamp || 0) - (a.timestamp || 0));
                
                container.innerHTML = list.map((student, idx) => `
                    <div class="bg-white p-3 rounded-lg shadow flex items-center justify-between">
                        <div class="flex items-center gap-3">
                            <span class="text-xl">✅</span>
                            <div>
                                <p class="font-semibold text-gray-800">${student.name}</p>
                                <p class="text-xs text-gray-600">${student.studentNumber}</p>
                                <p class="text-xs text-gray-500">${student.time}</p>
                            </div>
                        </div>
                        <span class="text-xs bg-blue-100 text-blue-700 px-2 py-1 rounded">
                            ${student.distance}m
                        </span>
                    </div>
                `).join('');
            }
        }

        function showNotification(message, type) {
            const existingNotif = document.getElementById('notification');
            if (existingNotif) {
                existingNotif.remove();
            }

            const notification = document.createElement('div');
            notification.id = 'notification';
            notification.className = `fixed top-4 right-4 px-6 py-3 rounded-lg shadow-lg z-50 ${
                type === 'success' ? 'bg-green-500' : 'bg-red-500'
            } text-white font-semibold`;
            notification.textContent = message;
            document.body.appendChild(notification);

            setTimeout(() => {
                notification.remove();
            }, 3000);
        }

        function downloadExcel() {
            getAttendanceData((list) => {
                if (list.length === 0) {
                    alert('İndirilecek veri yok!');
                    return;
                }

                const courseName = document.getElementById('courseName')?.value || 'Yoklama';
                const date = new Date().toLocaleDateString('tr-TR').replace(/\./g, '-');
                
                const excelData = list.map((student, idx) => ({
                    'Sıra': idx + 1,
                    'Ad Soyad': student.name,
                    'Öğrenci No': student.studentNumber || '-',
                    'Tarih/Saat': student.time,
                    'Mesafe (m)': student.distance,
                    'Enlem': student.location?.lat?.toFixed(6) || '-',
                    'Boylam': student.location?.lng?.toFixed(6) || '-',
                    'Doğruluk': student.accuracy ? `±${student.accuracy}m` : '-'
                }));

                const ws = XLSX.utils.json_to_sheet(excelData);
                const wb = XLSX.utils.book_new();
                XLSX.utils.book_append_sheet(wb, ws, 'Yoklama');

                ws['!cols'] = [
                    { wch: 6 }, { wch: 25 }, { wch: 15 }, { wch: 20 },
                    { wch: 12 }, { wch: 12 }, { wch: 12 }, { wch: 12 }
                ];

                XLSX.writeFile(wb, `${courseName}_Yoklama_${date}.xlsx`);
            });
        }

        function downloadCSV() {
            getAttendanceData((list) => {
                if (list.length === 0) {
                    alert('İndirilecek veri yok!');
                    return;
                }

                const courseName = document.getElementById('courseName')?.value || 'Yoklama';
                const date = new Date().toLocaleDateString('tr-TR').replace(/\./g, '-');

                let csv = 'Sıra,Ad Soyad,Öğrenci No,Tarih/Saat,Mesafe (m),Enlem,Boylam,Doğruluk\n';

                list.forEach((student, idx) => {
                    csv += `${idx + 1},"${student.name}","${student.studentNumber || '-'}","${student.time}",${student.distance},${student.location?.lat?.toFixed(6) || '-'},${student.location?.lng?.toFixed(6) || '-'},${student.accuracy ? '±' + student.accuracy + 'm' : '-'}\n`;
                });

                const blob = new Blob(['\ufeff' + csv], { type: 'text/csv;charset=utf-8;' });
                const link = document.createElement('a');
                link.href = URL.createObjectURL(blob);
                link.download = `${courseName}_Yoklama_${date}.csv`;
                link.click();
            });
        }

        function getAttendanceData(callback) {
            if (useFirebase && currentSessionId) {
                database.ref('sessions/' + currentSessionId + '/attendances').once('value', (snapshot) => {
                    const data = snapshot.val();
                    let list = [];
                    if (data) {
                        list = Object.values(data);
                    }
                    callback(list);
                });
            } else {
                const list = JSON.parse(localStorage.getItem('attendanceList') || '[]');
                callback(list);
            }
        }

        function clearAttendance() {
            if (confirm('Yoklama listesini temizlemek istediğinizden emin misiniz?')) {
                if (useFirebase && currentSessionId) {
                    database.ref('sessions/' + currentSessionId + '/attendances').remove();
                } else {
                    localStorage.removeItem('attendanceList');
                }
                loadAttendanceList();
            }
        }
    </script>
</body>
</html>
